<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DSS GIG — Painel do Gestor</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <style>
    .filters-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:640px){ .filters-grid { grid-template-columns:1fr; } }
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .site-header { box-shadow: none; }
      .card { box-shadow: none; border:1px solid #999; }
      .actions button { display:none; }
    }
  </style>
  <link rel="shortcut icon" href="icone lsg.ico">
</head>
<body>
<header class="site-header">
  <img src="logo lsg.png" alt="logo LSG">
  <h1>Painel do Gestor — DSS GIG</h1>
  <p class="subtitle">Busque e gere relatórios em PDF (otimizado para impressão em papel)</p>
</header>
<main class="container">
  <section class="card">
    <h2>Filtros</h2>
    <div class="filters-grid">
      <div class="row">
        <label for="fMat">Matrícula</label>
        <input type="text" id="fMat" placeholder="Ex.: 12345" />
      </div>
      <div class="row">
        <label for="fNome">Nome</label>
        <input type="text" id="fNome" placeholder="Nome do colaborador" />
      </div>
      <div class="row">
        <label for="fSem">Semana (YYYY-Www)</label>
        <input type="text" id="fSem" placeholder="Ex.: 2026-W03" />
      </div>
    </div>
    <div class="actions">
      <button id="btnBuscar" class="primary">Buscar</button>
      <button id="btnAddFunc" class="secondary">Novo Funcionário</button>
      <button id="btnPDF" class="secondary">Gerar PDF</button>
    </div>
    <div id="status" class="message"></div>
  </section>
  <section class="card">
    <h2>Resultados</h2>
    <div class="table-wrapper">
      <table id="tbl" class="table">
        <thead>
          <tr>
            <th>Matrícula</th>
            <th>Funcionário</th>
            <th>Setor</th>
            <th>Semana</th>
            <th>Data de participação</th>
            <th>Assinatura</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>
<footer class="site-footer">
  <small>© Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG</small>
</footer>
<script>
  const API_BASE = '/api/gas';
  let registros = [];

  // ===== Logo da LSG Sky Chefs =====
  // Tente carregar do arquivo local (logo lsg.png); se falhar, usa um fallback em base64 (se definido).
  const LOGO_SRC = 'logo lsg.png';
  let FIXED_LOGO_DATAURL = '';

  function loadLogoDataUrl() {
    return new Promise(resolve => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        try {
          const canvas = document.createElement('canvas');
          canvas.width = img.width; canvas.height = img.height;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0);
          FIXED_LOGO_DATAURL = canvas.toDataURL('image/png');
          resolve(FIXED_LOGO_DATAURL);
        } catch(e) { resolve(FIXED_LOGO_DATAURL || ''); }
      };
      img.onerror = () => resolve(FIXED_LOGO_DATAURL || '');
      img.src = LOGO_SRC;
    });
  }

  document.getElementById('btnBuscar').addEventListener('click', buscar);
  document.getElementById('btnPDF').addEventListener('click', gerarPDF);
  document.getElementById('btnAddFunc').addEventListener('click', novoFuncionarioViaPrompt);

  async function buscar(){
    const status = document.getElementById('status'); status.innerHTML='';
    const fMat = document.getElementById('fMat').value.trim();
    const fNome = document.getElementById('fNome').value.trim();
    const fSem = document.getElementById('fSem').value.trim();
    const qs = new URLSearchParams({ action:'registros' });
    if (fMat) qs.append('matricula', fMat);
    if (fNome) qs.append('nome', fNome);
    if (fSem) qs.append('semana', fSem);
    try{
      const res = await fetch(API_BASE + '?' + qs.toString());
      let data; try{ data = await res.json(); }catch{ data = { ok:false, error:'Resposta não-JSON do proxy', status:res.status }; }
      if (!data.ok) throw new Error(data.error || 'Erro ao buscar');
      registros = data.data || [];
      renderTabela(registros);
      status.innerHTML = '<div class="ok">Busca concluída: ' + registros.length + ' registro(s).</div>';
    }catch(err){ status.innerHTML = '<div class="error">Falha na consulta.</div>'; }
  }

  function renderTabela(list){
    const tbody = document.getElementById('tbody'); tbody.innerHTML='';
    if(!list || list.length===0){ tbody.innerHTML='<tr><td colspan="6" class="muted">Sem resultados</td></tr>'; return; }
    list.forEach(r=>{
      const tr=document.createElement('tr');
      const dataPart = formatTimestamp(r.Timestamp);
      tr.innerHTML = `
        <td>${r.Matricula || ''}</td>
        <td>${r.Nome || ''}</td>
        <td>${r.Setor || ''}</td>
        <td>${r.SemanaISO || ''}</td>
        <td>${dataPart}</td>
        <td>${r.AssinaturaPNG ? '<img class="sig-img" src="'+r.AssinaturaPNG+'" alt="Assinatura" />' : '-'}</td>`;
      tbody.appendChild(tr);
    });
  }

  function formatTimestamp(ts){ try{ const d=new Date(ts); if(!isNaN(d.getTime())) return d.toLocaleString('pt-BR'); }catch(e){} return String(ts||''); }

  async function gerarPDF(){
    // Garante que o logo esteja em DataURL
    await loadLogoDataUrl();

    if(!registros || registros.length===0){ alert('Nenhum dado para gerar PDF.'); return; }

    // Semana escolhida e Título do Vídeo (relatório)
    const semanaEscolhida = (document.getElementById('fSem').value || '').trim();
    const semanasEncontradas = [...new Set(registros.map(r=>r.SemanaISO).filter(Boolean))];
    const semanaTexto = semanaEscolhida || (semanasEncontradas.join(', ') || '-');
    const titulos = [...new Set(registros.map(r=>r.TituloVideo).filter(Boolean))];
    const tituloRel = titulos.join('; ');

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });

    const marginLeft = 48, marginRight = 48, marginTop = 96, marginBottom = 80;
    const pageWidth = doc.internal.pageSize.getWidth();
    const usableWidth = pageWidth - marginLeft - marginRight;

    // ===== Tabela (sem coluna de Título; o título vai no cabeçalho) =====
    const head = [['Matrícula','Funcionário','Setor','Data de participação','Assinatura']];
    const body = registros.map(r=>[
      r.Matricula||'', r.Nome||'', r.Setor||'', formatTimestamp(r.Timestamp)||'', ''
    ]);

    const LOGO_W = 110, LOGO_H = 48; // dimensões agradáveis para o cabeçalho
    const headerY = 28; // y base do cabeçalho
    const lineH = 14;

    function drawHeaderFooter(data){
      // HEADER (logo à esquerda + "Semana do DSS: ... — <Título>")
      try{ if(FIXED_LOGO_DATAURL) doc.addImage(FIXED_LOGO_DATAURL,'PNG', marginLeft, headerY-8, LOGO_W, LOGO_H);}catch(e){}
      doc.setFont('helvetica','bold'); doc.setFontSize(12);
      const headerText = `Semana do DSS: ${semanaTexto}` + (tituloRel ? ` — ${tituloRel}` : '');
      const textX = marginLeft + LOGO_W + 12;
      const wrapped = doc.splitTextToSize(headerText, usableWidth - (LOGO_W + 12));
      doc.text(wrapped, textX, headerY + 8);

      // FOOTER (data/hora + 3 linhas de endereço)
      const pageHeight = doc.internal.pageSize.getHeight();
      const startY = pageHeight - marginBottom + 10; // afastado um pouco da borda
      const generatedAt = new Date().toLocaleString('pt-BR');
      doc.setFont('helvetica','italic'); doc.setFontSize(9);
      doc.text('Gerado em: ' + generatedAt, marginLeft, startY);
      doc.setFont('helvetica','normal'); doc.setFontSize(9);
      doc.text('Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG', marginLeft, startY + lineH);
      doc.text('CNPJ 33.375.601/0001-38', marginLeft, startY + 2*lineH);
      doc.text('Rua P, S/N, Área de Apoio do Aeroporto Internacional do Rio de Janeiro - Ilha do Governador - RJ', marginLeft, startY + 3*lineH);
    }

    doc.autoTable({
      startY: marginTop,
      head, body,
      margin: { left: marginLeft, right: marginRight, top: marginTop, bottom: marginBottom },
      tableWidth: usableWidth,
      styles: { font:'helvetica', fontSize:9, cellPadding:4, valign:'middle', overflow:'linebreak' },
      headStyles: { fillColor:[33,150,243], textColor:255, halign:'center' },
      columnStyles: {
        0: { cellWidth: 70, halign:'left' },
        1: { cellWidth: 170, halign:'left' },
        2: { cellWidth: 110, halign:'left' },
        3: { cellWidth: 130, halign:'left' },
        4: { cellWidth: 110, halign:'center' }
      },
      didDrawPage: drawHeaderFooter,
      didDrawCell: function(data){
        if(data.section==='body' && data.column.index===4){
          const i=data.row.index; const sig=registros[i].AssinaturaPNG; if(sig){
            try{
              const maxW = Math.min(90, data.cell.width - 8);
              const maxH = 24;
              const x = data.cell.x + (data.cell.width - maxW)/2;
              const yImg = data.cell.y + (data.cell.height - maxH)/2;
              doc.addImage(sig,'PNG', x, yImg, maxW, maxH);
            }catch(e){}
          }
        }
      }
    });

    doc.save('Relatorio_DSS.pdf');
  }

  // Inclusão de novo funcionário (máscara + confirmação)
  async function novoFuncionarioViaPrompt(){
    const status = document.getElementById('status');
    try{
      // Máscara: somente números, exatamente 5 dígitos
      let mRaw = prompt('Nova matrícula (5 dígitos, apenas números):');
      if (mRaw === null) return; // cancelado
      mRaw = (mRaw || '').replace(/\D/g,'');
      while (!/^\d{5}$/.test(mRaw)) {
        mRaw = prompt('Matrícula inválida. Informe 5 dígitos (ex.: 12345):', mRaw);
        if (mRaw === null) return; // cancelado
        mRaw = (mRaw || '').replace(/\D/g,'');
      }
      const matricula = mRaw;

      let nome = prompt('Nome completo:');
      if (nome === null) return; // cancelado
      nome = (nome || '').trim();
      if (!nome) { alert('Nome é obrigatório.'); return; }

      let setor = prompt('Setor (opcional):');
      if (setor === null) setor = '';
      setor = (setor || '').trim();

      const resumo = `Confirmar cadastro?\n\nMatrícula: ${matricula}\nNome: ${nome}\nSetor: ${setor || '-'}\nAtivo: TRUE`;
      const ok = confirm(resumo);
      if (!ok) { status.innerHTML = '<div class="warn">Operação cancelada.</div>'; return; }

      const payload = { matricula, nome, setor, ativo: true };
      status.innerHTML = '<div class="warn">Enviando novo funcionário...</div>';
      const res = await fetch(API_BASE+'?action=addFuncionario',{
        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
      });
      let data; try{ data = await res.json(); } catch{ data = { ok:false, error:'Resposta não-JSON', status: res.status }; }
      if(!data.ok) throw new Error(data.error || 'Falha ao incluir funcionário');

      status.innerHTML = '<div class="ok">Funcionário incluído com sucesso.</div>';
    }catch(err){
      status.innerHTML = '<div class="error">'+ (err && err.message ? err.message : 'Erro ao incluir funcionário') +'</div>';
    }
  }
</script>
</body>
</html>