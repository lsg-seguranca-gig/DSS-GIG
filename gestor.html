<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DSS GIG — Painel do Gestor</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo" />
  <link rel="stylesheet" href="styles.css" />
  <!-- jsPDF + AutoTable (CDNs) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js">
async function gerarPDF(){
  if(!window.jspdf || !window.jspdf.jsPDF){ alert('Biblioteca jsPDF não carregou. Verifique rede/CDN.'); return; }
  await loadLogoAsDataURL();

  const baseSource = (registrosFiltrados && registrosFiltrados.length) ? registrosFiltrados : registros;
  if(!baseSource || !baseSource.length){ alert('Nenhum dado para gerar PDF.'); return; }

  // Ordenar por Nome (A→Z, pt-BR)
  const base = [...baseSource].sort((a,b)=> String(a.Nome||'').localeCompare(String(b.Nome||''),'pt-BR',{sensitivity:'base'}));

  // Cabeçalho contextual (Semana via títulos)
  const titulos = [...new Set(base.map(r=>r.TituloVideo).filter(Boolean))];
  const tituloSemana = titulos.length ? titulos.join('; ') : '-';

  // Assuntos
  let assuntosCabecalho = '';
  try{
    const tList = await fetchTreinamentos();
    const semanasISO = [...new Set(base.map(r=>r.SemanaISO).filter(Boolean))];
    if (tList && tList.length){
      const setISO = new Set(semanasISO);
      let hit = tList.find(t => setISO.has(String(t['SemanaISO'])));
      if (!hit && titulos.length) hit = tList.find(t => String(t['Titulo']).trim() === titulos[0]);
      assuntosCabecalho = hit && hit['Assuntos'] ? String(hit['Assuntos']) : '';
    }
  }catch(e){}

  // Data e hora (duas linhas separadas)
  function pad(n){ return String(n).padStart(2,'0'); }
  const now = new Date();
  const geradoStr = `Gerado em: ${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });

  const marginLeft=48, marginRight=48, marginTop=120, marginBottom=88;
  const pageWidth  = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const usableWidth = pageWidth - marginLeft - marginRight;
  const LOGO_W=120, LOGO_H=52;

  const LINE = 14; // altura de linha aproximada

  // Desenha Cabeçalho (com logo) e Rodapé para TODAS as páginas
  function drawHeaderFooter(){
    // Logo em TODAS as páginas
    try{ if(LOGO_DATAURL) doc.addImage(LOGO_DATAURL,'PNG', pageWidth - marginRight - LOGO_W, 28, LOGO_W, LOGO_H); }catch(e){}

    // Título
    doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.text('Diálogo Semanal de Segurança', marginLeft, 48);

    // Semana
    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    const semanaText  = 'Semana: ' + (tituloSemana || '-');
    const semanaLines = doc.splitTextToSize(semanaText, usableWidth - (LOGO_W + 12));
    const ySemana     = 78;
    doc.text(semanaLines, marginLeft, ySemana);

    // +2 linhas entre Semana e Assunto
    let y = ySemana + LINE * Math.max(2, semanaLines.length) + LINE*2;

    // Assuntos
    if (assuntosCabecalho && assuntosCabecalho.length){
      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      const assLines = doc.splitTextToSize('Assuntos: ' + assuntosCabecalho, usableWidth);
      doc.text(assLines, marginLeft, y);
      y += LINE * Math.max(1, assLines.length);
    }

    // Uma linha: Data e Hora
    doc.setFont('helvetica','normal');
    doc.setFontSize(10);
    doc.text(geradoStr, marginLeft, y + LINE);   // linha 2

    // Rodapé (3 linhas) — texto institucional
    doc.setFont('helvetica','normal'); doc.setFontSize(7);
    const FOOT_LH=12, FOOT_Y=pageHeight-22;
    doc.text('Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG', marginLeft, FOOT_Y - (FOOT_LH * 2));
    doc.text('CNPJ 33.375.601/0001-38',                                marginLeft, FOOT_Y - (FOOT_LH * 1));
    doc.text('Rua P, S/N, Área de Apoio do Aeroporto Internacional do Rio de Janeiro - Ilha do Governador - RJ', marginLeft, FOOT_Y);
  }

  // Tabela
  const head = [['Matrícula','Funcionário','Setor','Data de Participação','Assinatura']];
  const body = base.map(r => [ r.Matricula||'', r.Nome||'', r.Setor||'', formatTimestamp(r.Timestamp)||'', '' ]);

  doc.autoTable({
    // StartY aumentado para caber: Semana + (1 linha extra) + Assuntos + 2 linhas (data/hora)
    startY: marginTop + LINE*4,
    head, body,
    margin: { left: marginLeft, right: marginRight, top: marginTop, bottom: marginBottom },
    tableWidth: usableWidth,
    styles: { font:'helvetica', fontSize:8, cellPadding:4, valign:'middle', overflow:'linebreak' },
    headStyles: { fillColor:[33,150,243], textColor:255, halign:'center' },
    didParseCell: (data)=>{ if (data.section==='body' && data.column.index===4) { data.cell.height = Math.max(data.cell.height, typeof SIG_MIN_H!=='undefined' ? SIG_MIN_H : 56); } },
    didDrawCell: (data)=>{
      if (data.section==='body' && data.column.index===4){
        const i = data.row.index; const sig = base[i].AssinaturaPNG;
        if(sig){ const pad=2; const x=data.cell.x+pad, y=data.cell.y+pad; const w=data.cell.width-pad*2, h=data.cell.height-pad*2; try{ doc.addImage(sig,'PNG',x,y,w,h);}catch(e){} }
      }
    },
    didDrawPage: ()=>{ drawHeaderFooter(); } // aplica em todas as páginas
  });

  // Paginação à DIREITA do rodapé
  const pageCount = doc.internal.getNumberOfPages();
  for (let i = 1; i <= pageCount; i++){
    doc.setPage(i);
    doc.setFont('helvetica','italic'); doc.setFontSize(8);
    const FOOT_Y = pageHeight - 22;
    const text   = `Página ${i} de ${pageCount}`;
    doc.text(text, pageWidth - marginRight, FOOT_Y + 2, { align:'right' });
  }

  doc.save(nomeArquivo('pdf'));
}

</script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <!-- XLSX (SheetJS) para gerar Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <link rel="shortcut icon" href="icone lsg.ico">
  <style>
    /* Fonte única */
    html, body, button, input, select, table, th, td, label, .card, .site-header {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
    }
    .container{ max-width:1000px; margin:24px auto; padding:0 16px; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin-bottom:16px; }
    .site-header{ background:linear-gradient(135deg,#1e293b,#0f172a); color:#fff; padding:24px; text-align:center; }
    .site-header img{ height:42px; vertical-align:middle; margin-bottom:8px; }
    .table{ width:100%; border-collapse:collapse; }
    .table th, .table td{ border:1px solid #e5e7eb; padding:8px; text-align:left; }
    .message{ margin-top:10px; }
    .sig-img{ height:48px; object-fit:contain; }

    /* ===== Filtros (duas linhas) ===== */
    .filters-wrap { display:flex; flex-direction:column; gap:14px; }
    .filters-row-1 { display:grid; grid-template-columns: 320px 1fr; gap:24px; }
    .filters-row-1 .col-mat input[type="text"]{ max-width:320px; }
    .filters-row-2 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:24px; }
    .filters-wrap .row { display:flex; flex-direction:column; align-items:flex-start; }
    .filters-wrap label { display:block; font-size:14px; margin-bottom:2px; line-height:1.2; color:#374151; }
    .filters-wrap input[type="text"],
    .filters-wrap input[type="date"],
    .filters-wrap select { height:40px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; color:#111827; box-sizing:border-box; width:100%; }

    .actions{ display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-top:6px; }
    .actions-left{ display:flex; gap:6px; flex-wrap:wrap; }
    .actions-right{ display:flex; gap:8px; }

    .primary{ background:#2563eb; color:#fff; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; }
    .secondary{ background:ButtonFace; color:ButtonText; border:1px solid ButtonBorder; padding:10px 14px; border-radius:8px; cursor:pointer; }

    @media (max-width: 900px){
      .filters-row-1{ grid-template-columns: 1fr; }
      .filters-row-2{ grid-template-columns: 1fr 1fr 1fr; }
      .actions{ justify-content:flex-start; gap:8px; }
      .actions-right{ margin-top:6px; }
    }

    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .site-header { box-shadow: none; }
      .card { box-shadow: none; border:1px solid #999; }
      .actions button { display:none; }
    }
  </style>
</head>
<body>
<header class="site-header">
  <img src="logo lsg.png" alt="logo LSG" />
  <h1>Painel do Gestor — DSS GIG</h1>
  <p class="subtitle">Busque e gere relatórios em PDF/XLS (otimizado para impressão)</p>
</header>

<main class="container">
  <section class="card">
    <h2>Filtros</h2>

    <div class="filters-wrap">
      <!-- Linha 1 -->
      <div class="filters-row-1">
        <div class="row col-mat">
          <label for="fMat">Matrícula</label>
          <input type="text" id="fMat" placeholder="Ex.: 12345" />
        </div>
        <div class="row col-nome">
          <label for="fNome">Nome</label>
          <input type="text" id="fNome" placeholder="Nome do colaborador" />
        </div>
      </div>

      <!-- Linha 2 -->
      <div class="filters-row-2">
        <div class="row">
          <label for="fSemanaTitulo">Semana</label>
          <select id="fSemanaTitulo">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="row">
          <label for="fDataInicio">Data Inicial</label>
          <input type="date" id="fDataInicio" />
        </div>
        <div class="row">
          <label for="fDataFinal">Data Final</label>
          <input type="date" id="fDataFinal" />
        </div>
      </div>

      <!-- Botões -->
      <div class="actions">
        <div class="actions-left">
          <button id="btnBuscar" class="primary">Buscar</button>
          <button id="btnXLS" class="secondary">Gerar XLS</button>
          <button id="btnPDF" class="secondary">Gerar PDF</button>
        </div>
        <div class="actions-right">
          <button id="btnAddFunc" class="secondary">Novo Funcionário</button>
        </div>
      </div>

      <div id="status" class="message"></div>
    </div>
  </section>

  <section class="card">
    <h2>Resultados</h2>
    <div class="table-wrapper">
      <table id="tbl" class="table">
        <thead>
          <tr>
            <th>Matrícula</th>
            <th>Funcionário</th>
            <th>Setor</th>
            <th>Semana</th>
            <th>Título do Vídeo</th>
            <th>Data de participação</th>
            <th>Assinatura</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="site-footer" style="text-align:center; color:#6b7280; padding:14px;">
  <small>© Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG</small>
</footer>

<script>
  const API_BASE = '/api/gas';
  const LOGO_SRC = 'logo lsg.png';
  let LOGO_DATAURL = '';

  // Estado
  let registros = [];
  let registrosFiltrados = [];

  // Logo
  function loadLogoAsDataURL(){
    return new Promise(resolve=>{
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = ()=>{ try{ const c=document.createElement('canvas'); c.width=img.width; c.height=img.height; c.getContext('2d').drawImage(img,0,0); LOGO_DATAURL=c.toDataURL('image/png'); resolve(LOGO_DATAURL);}catch(e){ resolve(LOGO_DATAURL=''); } };
      img.onerror = ()=> resolve(LOGO_DATAURL='');
      img.src = LOGO_SRC;
    });
  }

  // Eventos
  document.getElementById('btnBuscar').addEventListener('click', buscar);
  document.getElementById('btnXLS').addEventListener('click', gerarXLS);
  document.getElementById('btnPDF').addEventListener('click', gerarPDF);
  document.getElementById('btnAddFunc').addEventListener('click', novoFuncionarioViaPrompt);

  // Enter => Buscar
  ['fMat','fNome','fDataInicio','fDataFinal','fSemanaTitulo'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); buscar(); } });
  });

  // Popular dropdown Semana (a partir dos Registros: TituloVideo)
  (async function popularTitulos(){
    try{
      const res = await fetch(API_BASE + '?action=registros');
      const data = await res.json();
      if (!data.ok) return;
      const all = Array.isArray(data.data) ? data.data : [];
      const titulos = Array.from(new Set(all.map(r => (r.TituloVideo||'').trim()).filter(Boolean)))
        .sort((a,b)=>a.localeCompare(b,'pt-BR',{sensitivity:'base'}));
      const sel = document.getElementById('fSemanaTitulo');
      sel.innerHTML = '<option value="">Todas</option>' + titulos.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    }catch(e){}
  })();

  // Buscar
  async function buscar(){
    const status = document.getElementById('status'); status.innerHTML='';
    const fMat = document.getElementById('fMat').value.trim();
    const fNome = document.getElementById('fNome').value.trim();
    const fTitulo = document.getElementById('fSemanaTitulo').value.trim();
    const fDataI = document.getElementById('fDataInicio').value;
    const fDataF = document.getElementById('fDataFinal').value;

    const qs = new URLSearchParams({ action:'registros' });
    if (fMat) qs.append('matricula', fMat);
    if (fNome) qs.append('nome', fNome);

    try{
      const res = await fetch(API_BASE + '?' + qs.toString());
      let data; try{ data = await res.json(); }catch{ data = { ok:false, error:'Resposta não-JSON do proxy', status:res.status }; }
      if (!data.ok) throw new Error(data.error || 'Erro ao buscar');
      registros = Array.isArray(data.data) ? data.data : [];

      // Filtros locais: Data e Titulo
      const di = normalizarDataInput(fDataI);
      const df = fimDoDia(normalizarDataInput(fDataF));
      let lista = registros.filter(r => {
        const ts = parseTimestamp(r.Timestamp);
        if (!ts) return false;
        if (di && ts < di) return false;
        if (df && ts > df) return false;
        if (fTitulo && (r.TituloVideo || '') !== fTitulo) return false;
        return true;
      });

      // Deduplicação por (Matricula + SemanaISO + TituloVideo), mantendo o mais antigo
      const mapa = new Map();
      for (const r of lista) {
        const chave = `${r.Matricula||''}__${r.SemanaISO||''}__${r.TituloVideo||''}`;
        const atual = mapa.get(chave);
        const novoTS = parseTimestamp(r.Timestamp);
        if (!atual) mapa.set(chave, r); else {
          const antigoTS = parseTimestamp(atual.Timestamp);
          if (novoTS && antigoTS && novoTS < antigoTS) mapa.set(chave, r);
        }
      }
      registrosFiltrados = Array.from(mapa.values())
        .sort((a,b)=> String(a.Nome||'').localeCompare(String(b.Nome||''),'pt-BR',{sensitivity:'base'}));

      renderTabela(registrosFiltrados);
      status.innerHTML = '<div class="ok">Busca concluída: ' + registrosFiltrados.length + ' registro(s).</div>';
    }catch(err){ status.innerHTML = '<div class="error">Falha na consulta.</div>'; }
  }

  function renderTabela(list){
    const tbody = document.getElementById('tbody'); tbody.innerHTML='';
    if(!list || list.length===0){ tbody.innerHTML='<tr><td colspan="7" class="muted">Sem resultados</td></tr>'; return; }
    tbody.innerHTML = list.map(r=>{
      const dataPart = formatTimestamp(r.Timestamp);
      const assinatura = r.AssinaturaPNG ? '<img class="sig-img" src="'+r.AssinaturaPNG+'" alt="Assinatura" />' : '-';
      return `
        <tr>
          <td>${escapeHtml(r.Matricula||'')}</td>
          <td>${escapeHtml(r.Nome||'')}</td>
          <td>${escapeHtml(r.Setor||'')}</td>
          <td>${escapeHtml(r.SemanaISO||'')}</td>
          <td>${escapeHtml(r.TituloVideo||'')}</td>
          <td>${escapeHtml(dataPart)}</td>
          <td>${assinatura}</td>
        </tr>`;
    }).join('');
  }

  // XLSX
  function gerarXLS(){
    const base = (registrosFiltrados && registrosFiltrados.length) ? registrosFiltrados : registros;
    if(!base || !base.length) { alert('Faça uma busca primeiro.'); return; }
    const linhas = base.map(r => ({
      'Matrícula': r.Matricula || '',
      'Funcionário': r.Nome || '',
      'Setor': r.Setor || '',
      'Semana (ISO)': r.SemanaISO || '',
      'Título do Vídeo': r.TituloVideo || '',
      'Data de participação': formatTimestamp(r.Timestamp)
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(linhas);
    XLSX.utils.book_append_sheet(wb, ws, 'Relatório');
    XLSX.writeFile(wb, nomeArquivo('xlsx'));
  }

  // Treinamentos (para Assuntos no PDF)
  async function fetchTreinamentos(){
    try{ const res = await fetch(API_BASE + '?action=treinamentos'); const data = await res.json(); if (!data.ok) return []; return Array.isArray(data.data) ? data.data : []; }catch(e){ return []; }
  }

  // PDF completo
  async function gerarPDF(){
    if(!window.jspdf || !window.jspdf.jsPDF){ alert('Biblioteca jsPDF não carregou. Verifique a rede/AD (CDN).'); return; }
    await loadLogoAsDataURL();

    const baseSource = (registrosFiltrados && registrosFiltrados.length) ? registrosFiltrados : registros;
    if(!baseSource || !baseSource.length){ alert('Nenhum dado para gerar PDF.'); return; }

    const base = [...baseSource].sort((a,b)=> String(a.Nome||'').localeCompare(String(b.Nome||''),'pt-BR',{sensitivity:'base'}));

    const titulos = [...new Set(base.map(r=>r.TituloVideo).filter(Boolean))];
    const tituloSemana = titulos.length ? titulos.join('; ') : '-';

    // Assuntos
    let assuntosCabecalho = '';
    try{
      const tList = await fetchTreinamentos();
      const semanasISO = [...new Set(base.map(r=>r.SemanaISO).filter(Boolean))];
      if (tList && tList.length){
        const setISO = new Set(semanasISO);
        let hit = tList.find(t => setISO.has(String(t['SemanaISO'])));
        if (!hit && titulos.length) hit = tList.find(t => String(t['Titulo']).trim() === titulos[0]);
        assuntosCabecalho = hit && hit['Assuntos'] ? String(hit['Assuntos']) : '';
      }
    }catch(e){}

    // === Data e Hora do relatório (duas linhas) ===
    function pad(n){ return String(n).padStart(2,'0'); }
  const now = new Date();
  const geradoStr = `Gerado em: ${pad(now.getDate())}/${pad(now.getMonth()+1)}/${now.getFullYear()} ${pad(now.getHours())}:${pad(now.getMinutes())}`;

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });

    const marginLeft=48, marginRight=48, marginTop=120, marginBottom=88;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const usableWidth = pageWidth - marginLeft - marginRight;
    const LOGO_W=120, LOGO_H=52;

    // Cabeçalho
    try{ if(LOGO_DATAURL) doc.addImage(LOGO_DATAURL,'PNG', pageWidth - marginRight - LOGO_W, 28, LOGO_W, LOGO_H); }catch(e){}
    doc.setFont('helvetica','bold'); doc.setFontSize(18);
    doc.text('Diálogo Semanal de Segurança', marginLeft, 48);

    doc.setFont('helvetica','bold'); doc.setFontSize(14);
    const headerText = 'Semana: ' + (tituloSemana || '-');
    doc.text(doc.splitTextToSize(headerText, usableWidth - (LOGO_W + 12)), marginLeft, 78);

    if (assuntosCabecalho && assuntosCabecalho.length){
      doc.setFont('helvetica','normal'); doc.setFontSize(11);
      doc.text(doc.splitTextToSize('Assuntos: ' + assuntosCabecalho, usableWidth), marginLeft, 96);
    }

    // Tabela
    const head = [['Matrícula','Funcionário','Setor','Data de Participação','Assinatura']];
    const body = base.map(r => [ r.Matricula||'', r.Nome||'', r.Setor||'', formatTimestamp(r.Timestamp)||'', '' ]);

    doc.autoTable({
      startY: (assuntosCabecalho ? (marginTop + 16) : marginTop),
      head, body,
      margin: { left: marginLeft, right: marginRight, top: marginTop, bottom: marginBottom },
      tableWidth: usableWidth,
      styles: { font:'helvetica', fontSize:8, cellPadding:4, valign:'middle', overflow:'linebreak' },
      headStyles: { fillColor:[33,150,243], textColor:255, halign:'center' },
      didParseCell: (data)=>{ if (data.section==='body' && data.column.index===4) { data.cell.height = Math.max(data.cell.height, typeof SIG_MIN_H!=='undefined' ? SIG_MIN_H : 56); } },
      didDrawCell: (data)=>{
        if (data.section==='body' && data.column.index===4){
          const i = data.row.index; const sig = base[i].AssinaturaPNG; if(sig){ const pad=2; const x=data.cell.x+pad, y=data.cell.y+pad; const w=data.cell.width-pad*2, h=data.cell.height-pad*2; try{ doc.addImage(sig,'PNG',x,y,w,h);}catch(e){} }
        }
      }
    });

    // Rodapé + paginação
    const FOOT_LH=14, FOOT_Y=pageHeight-22, paginationY = FOOT_Y + 4;
    const rod1='Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG';
    const rod2='CNPJ 33.375.601/0001-38';
    const rod3='Rua P, S/N, Área de Apoio do Aeroporto Internacional do Rio de Janeiro - Ilha do Governador - RJ';

    const pageCount = doc.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++){
      doc.setPage(i);
      doc.setFont('helvetica','normal'); doc.setFontSize(7);
      doc.text(rod1, marginLeft, FOOT_Y - (FOOT_LH * 2));
      doc.text(rod2, marginLeft, FOOT_Y - (FOOT_LH * 1));
      doc.text(rod3, marginLeft, FOOT_Y - (FOOT_LH * 0));
      doc.setFont('helvetica','italic'); doc.setFontSize(8);
      const paginationY = FOOT_Y + 2;
      doc.text(`Página ${i} de ${pageCount}`, pageWidth/2, paginationY, { align:'center' });
    }

    doc.save(nomeArquivo('pdf'));
  }

  // Novo funcionário
  async function novoFuncionarioViaPrompt(){
    const status = document.getElementById('status');
    try{
      let mRaw = prompt('Nova matrícula (5 dígitos, apenas números):'); if (mRaw === null) return; mRaw = (mRaw||'').replace(/\D/g,'');
      while (!/^\d{5}$/.test(mRaw)) { mRaw = prompt('Matrícula inválida. Informe 5 dígitos (ex.: 12345):', mRaw); if (mRaw === null) return; mRaw = (mRaw||'').replace(/\D/g,''); }
      const matricula = mRaw;
      let nome = prompt('Nome completo:'); if (nome === null) return; nome = (nome||'').trim(); if (!nome) { alert('Nome é obrigatório.'); return; }
      let setor = prompt('Setor (opcional):'); if (setor === null) setor = ''; setor = (setor||'').trim();
      const ok = confirm(`Confirmar cadastro?\n\nMatrícula: ${matricula}\nNome: ${nome}\nSetor: ${setor||'-'}\nAtivo: TRUE`); if (!ok) { status.innerHTML='<div class="warn">Operação cancelada.</div>'; return; }
      const payload = { matricula, nome, setor, ativo: true };
      status.innerHTML = '<div class="warn">Enviando novo funcionário...</div>';
      const res = await fetch(API_BASE+'?action=addFuncionario',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      let data; try{ data = await res.json(); } catch{ data = { ok:false, error:'Resposta não-JSON', status: res.status }; }
      if(!data.ok) throw new Error(data.error || 'Falha ao incluir funcionário');
      status.innerHTML = '<div class="ok">Funcionário incluído com sucesso.</div>';
    }catch(err){ status.innerHTML = '<div class="error">'+ (err && err.message ? err.message : 'Erro ao incluir funcionário') +'</div>'; }
  }

  // Utils
  function escapeHtml(str){ return String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s])); }
  function nomeArquivo(ext){ const hoje=new Date(); const pad=n=>String(n).padStart(2,'0'); return `DSS_GIG_Relatorio_${hoje.getFullYear()}-${pad(hoje.getMonth()+1)}-${pad(hoje.getDate())}.${ext}`; }
  function normalizarDataInput(v){ if(!v) return null; const [yyyy,mm,dd]=v.split('-').map(Number); return new Date(Date.UTC(yyyy, mm-1, dd, 0,0,0)); }
  function fimDoDia(dIni){ if(!dIni) return null; return new Date(dIni.getTime()+24*60*60*1000-1); }
  function parseTimestamp(valor){ if(!valor) return null; let d=new Date(valor); if(!Number.isNaN(d.getTime())) return d; const rx=/(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/; const m=String(valor).trim().match(rx); if(m){ const dd=+m[1], mm=+m[2], yy=+m[3]; const hh=+(m[4]??0), mi=+(m[5]??0), ss=+(m[6]??0); return new Date(yy,mm-1,dd,hh,mi,ss);} return null; }
  function formatTimestamp(ts){ const d=parseTimestamp(ts); if(!d) return String(ts||''); const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
</script>
</body>
</html>
