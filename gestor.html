<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DSS GIG — Painel do Gestor</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo" />
  <link rel="stylesheet" href="styles.css" />
  <!-- jsPDF + AutoTable (CDNs fixos) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <!-- XLSX (SheetJS) + JSZip + FileSaver -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    html, body, button, input, select, table, th, td, label, .card, .site-header {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
    }
    .container{ max-width:1000px; margin:24px auto; padding:0 16px; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:20px; margin-bottom:16px; }
    .site-header{ background:linear-gradient(135deg,#1e293b,#0f172a); color:#fff; padding:24px; text-align:center; }
    .site-header img{ height:42px; vertical-align:middle; margin-bottom:8px; }
    .subtitle{ color:#9ca3af; margin:4px 0 0 0 }
    .table{ width:100%; border-collapse:collapse; }
    .table th, .table td{ border:1px solid #e5e7eb; padding:8px; text-align:left; }
    .message{ margin-top:10px; }
    .sig-img{ height:48px; object-fit:contain; }

    /* Filtros */
    .filters-wrap { display:flex; flex-direction:column; gap:14px; }
    .filters-row-1 { display:grid; grid-template-columns: 320px 1fr; gap:24px; }
    .filters-row-1 .col-mat input[type="text"]{ max-width:320px; }
    .filters-row-2 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:24px; }
    .filters-wrap .row { display:flex; flex-direction:column; align-items:flex-start; }
    .filters-wrap label { display:block; font-size:14px; margin-bottom:2px; line-height:1.2; color:#374151; }
    .filters-wrap input[type="text"], .filters-wrap input[type="date"], .filters-wrap select {
      height:40px; padding:10px 12px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; color:#111827; box-sizing:border-box; width:100%; }

    .actions{ display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-top:6px; }
    .actions-left{ display:flex; gap:6px; flex-wrap:wrap; }
    .actions-right{ display:flex; gap:8px; }

    .primary{ background:#2563eb; color:#fff; padding:10px 14px; border:none; border-radius:8px; cursor:pointer; }
    .secondary{ background:ButtonFace; color:ButtonText; border:1px solid ButtonBorder; padding:10px 14px; border-radius:8px; cursor:pointer; }

    @media (max-width: 900px){
      .filters-row-1{ grid-template-columns: 1fr; }
      .filters-row-2{ grid-template-columns: 1fr 1fr 1fr; }
      .actions{ justify-content:flex-start; gap:8px; }
      .actions-right{ margin-top:6px; }
    }

    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .site-header { box-shadow: none; }
      .card { box-shadow: none; border:1px solid #999; }
      .actions button { display:none; }
    }
  </style>
</head>
<body>
<header class="site-header">
  <img src="logo lsg.png" alt="logo LSG" />
  <h1>Painel do Gestor — DSS GIG</h1>
  <p id="buildBadge" class="subtitle"></p>
</header>

<main class="container">
  <section class="card">
    <h2>Filtros</h2>

    <div class="filters-wrap">
      <div class="filters-row-1">
        <div class="row col-mat">
          <label for="fMat">Matrícula</label>
          <input type="text" id="fMat" placeholder="Ex.: 12345" />
        </div>
        <div class="row col-nome">
          <label for="fNome">Nome</label>
          <input type="text" id="fNome" placeholder="Nome do colaborador" />
        </div>
      </div>

      <div class="filters-row-2">
        <div class="row">
          <label for="fSemanaTitulo">Semana</label>
          <select id="fSemanaTitulo">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="row">
          <label for="fDataInicio">Data Inicial</label>
          <input type="date" id="fDataInicio" />
        </div>
        <div class="row">
          <label for="fDataFinal">Data Final</label>
          <input type="date" id="fDataFinal" />
        </div>
      </div>

      <div class="actions">
        <div class="actions-left">
          <button id="btnBuscar" class="primary">Buscar</button>
          <button id="btnXLS" class="secondary">Gerar XLS</button>
          <button id="btnPDF" class="secondary">Gerar PDF</button>
          <button id="btnZIP" class="secondary">Gerar Pacote Offline (ZIP)</button>
        </div>
        <div class="actions-right">
          <button id="btnAddFunc" class="secondary">Novo Funcionário</button>
        </div>
      </div>

      <div id="status" class="message"></div>
    </div>
  </section>

  <section class="card">
    <h2>Resultados</h2>
    <div class="table-wrapper">
      <table id="tbl" class="table">
        <thead>
          <tr>
            <th>Matrícula</th>
            <th>Funcionário</th>
            <th>Setor</th>
            <th>Semana</th>
            <th>Título do Vídeo</th>
            <th>Data de participação</th>
            <th>Assinatura</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="site-footer" style="text-align:center; color:#6b7280; padding:14px;">
  <small>© Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG</small>
</footer>

<script>
(function(){
  // ====== Setup de build badge ======
  try{ document.getElementById('buildBadge').textContent = 'Build: ' + new Date().toLocaleString('pt-BR') + ' (clean v3)'; }catch(e){}

  // ====== Estado ======
  window.registros = [];
  window.registrosFiltrados = [];
  window.LOGO_DATAURL = '';

  // ====== Logo para PDF ======
  function loadLogoAsDataURL(){
    return new Promise(function(resolve){
      var img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = function(){ try{ var c=document.createElement('canvas'); c.width=img.width; c.height=img.height; c.getContext('2d').drawImage(img,0,0); window.LOGO_DATAURL=c.toDataURL('image/png'); resolve(window.LOGO_DATAURL);}catch(e){ resolve(window.LOGO_DATAURL=''); } };
      img.onerror = function(){ resolve(window.LOGO_DATAURL=''); };
      img.src = 'logo lsg.png';
    });
  }

  // ====== Utilitários ======
  function parseTimestamp(valor){ if(!valor) return null; var d=new Date(valor); if(!isNaN(d.getTime())) return d; var rx=/(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?/; var m=String(valor).trim().match(rx); if(m){ var dd=+m[1], mm=+m[2], yy=+m[3]; var hh=+(m[4]||0), mi=+(m[5]||0), ss=+(m[6]||0); return new Date(yy,mm-1,dd,hh,mi,ss);} return null; }
  function formatTimestamp(ts){ var d=parseTimestamp(ts); if(!d) return String(ts||''); function pad(n){return String(n).padStart(2,'0');} return pad(d.getDate())+'/'+pad(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad(d.getHours())+':'+pad(d.getMinutes()); }
  function normalizarDataInput(v){ if(!v) return null; var p=v.split('-'); return new Date(Date.UTC(+p[0], +p[1]-1, +p[2], 0,0,0)); }
  function fimDoDia(d){ if(!d) return null; return new Date(d.getTime()+24*60*60*1000-1); }
  function escapeHtml(s){
    s = String(s||'');
    return s.replace(/[&<>"']/g, function(ch){
      if (ch==='&') return '&amp;';
      if (ch==='<') return '&lt;';
      if (ch==='>') return '&gt;';
      if (ch==='"') return '&quot;';
      return '&#39;';
    });
  }

  // ====== Popular dropdown Semanas (por TituloVideo) ======
  function popularSemanas(){
    var sel = document.getElementById('fSemanaTitulo'); if(!sel) return;
    fetch('/api/gas?action=registros').then(function(r){return r.json();}).then(function(data){
      if(!data || !data.ok) return;
      var all = Array.isArray(data.data)? data.data : [];
      var set = {};
      for (var i=0;i<all.length;i++){
        var t = (all[i] && all[i].TituloVideo) ? String(all[i].TituloVideo).trim() : '';
        if(t) set[t]=1;
      }
      var titulos = Object.keys(set).sort(function(a,b){ return a.localeCompare(b,'pt-BR',{sensitivity:'base'}); });
      var opts = '<option value="">Todas</option>';
      for (var j=0;j<titulos.length;j++){
        var t2 = titulos[j];
        opts += '<option value="'+escapeHtml(t2)+'">'+escapeHtml(t2)+'</option>';
      }
      sel.innerHTML = opts;
    }).catch(function(err){ console.warn('Falha ao popular semanas', err); });
  }

  // ====== Buscar ======
  function buscar(){
    var status = document.getElementById('status'); status.innerHTML='';
    var fMat = document.getElementById('fMat').value.trim();
    var fNome = document.getElementById('fNome').value.trim();
    var fTitulo = document.getElementById('fSemanaTitulo').value.trim();
    var fDataI = document.getElementById('fDataInicio').value;
    var fDataF = document.getElementById('fDataFinal').value;

    var qs = new URLSearchParams({ action:'registros' });
    if (fMat) qs.append('matricula', fMat);
    if (fNome) qs.append('nome', fNome);

    fetch('/api/gas?'+qs.toString()).then(function(res){ return res.json(); }).then(function(data){
      if(!data || !data.ok){ throw new Error('Falha na API'); }
      window.registros = Array.isArray(data.data)? data.data : [];

      var di = normalizarDataInput(fDataI);
      var df = fimDoDia(normalizarDataInput(fDataF));
      var lista = window.registros.filter(function(r){
        var ts = parseTimestamp(r.Timestamp);
        if(!ts) return false;
        if(di && ts < di) return false;
        if(df && ts > df) return false;
        if(fTitulo && (r.TituloVideo||'') !== fTitulo) return false;
        return true;
      });

      // Deduplicação por (Matricula + SemanaISO + TituloVideo), mantendo mais antigo
      var mapa = {};
      for (var i=0;i<lista.length;i++){
        var r = lista[i];
        var chave = (r.Matricula||'')+'__'+(r.SemanaISO||'')+'__'+(r.TituloVideo||'');
        var atual = mapa[chave];
        var novoTS = parseTimestamp(r.Timestamp);
        if(!atual) mapa[chave] = r; else {
          var antigoTS = parseTimestamp(atual.Timestamp);
          if(novoTS && antigoTS && novoTS < antigoTS) mapa[chave] = r;
        }
      }
      window.registrosFiltrados = Object.keys(mapa).map(function(k){return mapa[k];}).sort(function(a,b){ return String(a.Nome||'').localeCompare(String(b.Nome||''),'pt-BR',{sensitivity:'base'}); });
      renderTabela(window.registrosFiltrados);
      status.innerHTML = '<div class="ok">Busca concluída: '+ window.registrosFiltrados.length +' registro(s).</div>';
    }).catch(function(){ status.innerHTML = '<div class="error">Falha na consulta.</div>'; });
  }

  function renderTabela(list){
    var tbody = document.getElementById('tbody'); tbody.innerHTML='';
    if(!list || !list.length){ tbody.innerHTML='<tr><td colspan="7" class="muted">Sem resultados</td></tr>'; return; }
    var rows = '';
    for (var i=0;i<list.length;i++){
      var r = list[i];
      var dataPart = formatTimestamp(r.Timestamp);
      var assinatura = r.AssinaturaPNG ? '<img class="sig-img" src="'+r.AssinaturaPNG+'" alt="Assinatura" />' : '-';
      rows += '<tr>'+
        '<td>'+escapeHtml(r.Matricula||'')+'</td>'+
        '<td>'+escapeHtml(r.Nome||'')+'</td>'+
        '<td>'+escapeHtml(r.Setor||'')+'</td>'+
        '<td>'+escapeHtml(r.SemanaISO||'')+'</td>'+
        '<td>'+escapeHtml(r.TituloVideo||'')+'</td>'+
        '<td>'+escapeHtml(dataPart)+'</td>'+
        '<td>'+assinatura+'</td>'+
      '</tr>';
    }
    tbody.innerHTML = rows;
  }

  // ====== XLS ======
  function gerarXLS(){
    var base = (window.registrosFiltrados && window.registrosFiltrados.length)? window.registrosFiltrados : window.registros;
    if(!base || !base.length){ alert('Faça uma busca primeiro.'); return; }
    var linhas = base.map(function(r){ return {
      'Matrícula': r.Matricula || '',
      'Funcionário': r.Nome || '',
      'Setor': r.Setor || '',
      'Semana (ISO)': r.SemanaISO || '',
      'Título do Vídeo': r.TituloVideo || '',
      'Data de participação': formatTimestamp(r.Timestamp)
    };});
    var wb = XLSX.utils.book_new();
    var ws = XLSX.utils.json_to_sheet(linhas);
    XLSX.utils.book_append_sheet(wb, ws, 'Relatório');
    XLSX.writeFile(wb, 'DSS_GIG_Relatorio_'+ new Date().toISOString().slice(0,10) +'.xlsx');
  }

  // ====== Assuntos (treinamentos) ======
  function fetchTreinamentos(){
    return fetch('/api/gas?action=treinamentos').then(function(r){return r.json();}).then(function(d){ return (d && d.ok && Array.isArray(d.data))? d.data : []; }).catch(function(){ return []; });
  }

  // ====== PDF ======
  function gerarPDF(){
    if(!window.jspdf || !window.jspdf.jsPDF){ alert('Biblioteca jsPDF não carregou. Verifique rede/CDN.'); return; }
    loadLogoAsDataURL().then(function(){
      var baseSource = (window.registrosFiltrados && window.registrosFiltrados.length)? window.registrosFiltrados : window.registros;
      if(!baseSource || !baseSource.length){ alert('Nenhum dado para gerar PDF.'); return; }
      var base = baseSource.slice().sort(function(a,b){ return String(a.Nome||'').localeCompare(String(b.Nome||''),'pt-BR',{sensitivity:'base'}); });

      fetchTreinamentos().then(function(tList){
        var titulos = [];
        var seen = {};
        for (var i=0;i<base.length;i++){ var t=base[i].TituloVideo; if(t && !seen[t]){ seen[t]=1; titulos.push(t); } }
        var tituloSemana = titulos.length? titulos.join('; ') : '-';
        var semanasISO = [];
        var sseen = {};
        for (var k=0;k<base.length;k++){ var s=base[k].SemanaISO; if(s && !sseen[s]){ sseen[s]=1; semanasISO.push(s); } }
        var assuntosCabecalho = '';
        if(tList && tList.length){
          var setISO = {};
          for (var u=0;u<semanasISO.length;u++){ setISO[semanasISO[u]] = 1; }
          var hit = null;
          for(var x=0;x<tList.length;x++){ var tt=tList[x]; if(setISO[String(tt['SemanaISO'])]){ hit=tt; break; } }
          if(!hit && titulos.length){
            for(var y=0;y<tList.length;y++){ var tt2=tList[y]; if(String(tt2['Titulo']).trim()===titulos[0]){ hit=tt2; break; } }
          }
          if(hit && hit['Assuntos']) assuntosCabecalho = String(hit['Assuntos']);
        }

        var jsPDF = window.jspdf.jsPDF; var doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
        var marginLeft=48, marginRight=48, marginTop=150, marginBottom=88;
        var pageWidth  = doc.internal.pageSize.getWidth();
        var pageHeight = doc.internal.pageSize.getHeight();
        var usableWidth = pageWidth - marginLeft - marginRight;
        var LOGO_W=120, LOGO_H=52; var LINE=12; var SIG_MIN_H=112;

        function drawHeaderFooter(pageNumber, totalPages){
          try{ if(window.LOGO_DATAURL) doc.addImage(window.LOGO_DATAURL,'PNG', pageWidth - marginRight - LOGO_W, 28, LOGO_W, LOGO_H); }catch(e){}
          doc.setFont('helvetica','bold'); doc.setFontSize(18); doc.text('Diálogo Semanal de Segurança', marginLeft, 48);
          doc.setFont('helvetica','bold'); doc.setFontSize(14);
          var semanaText = 'Semana: ' + (tituloSemana || '-');
          var semanaLines = doc.splitTextToSize(semanaText, usableWidth - (LOGO_W + 12));
          var ySemana = 78; doc.text(semanaLines, marginLeft, ySemana);
          var y = ySemana + LINE * Math.max(1, semanaLines.length) + LINE;
          if (assuntosCabecalho && assuntosCabecalho.length){
            doc.setFont('helvetica','normal'); doc.setFontSize(11);
            var assuntosLines = doc.splitTextToSize('Assuntos: ' + assuntosCabecalho, usableWidth);
            doc.text(assuntosLines, marginLeft, y);
            y += LINE * Math.max(1, assuntosLines.length);
          }
          var dt = new Date();
          var linhaDH = 'Relatório gerado em ' + String(dt.getDate()).padStart(2,'0') + '/' + String(dt.getMonth()+1).padStart(2,'0') + '/' + dt.getFullYear() + ' às ' + String(dt.getHours()).padStart(2,'0') + ':' + String(dt.getMinutes()).padStart(2,'0');
          doc.setFont('helvetica','normal'); doc.setFontSize(10);
          doc.text(linhaDH, marginLeft, y + LINE);

          doc.setFont('helvetica','normal'); doc.setFontSize(7);
          var FOOT_LH=12, FOOT_Y=pageHeight-22;
          doc.text('Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG', marginLeft, FOOT_Y - (FOOT_LH * 2));
          doc.text('CNPJ 33.375.601/0001-38',                                marginLeft, FOOT_Y - (FOOT_LH * 1));
          doc.text('Rua P, S/N, Área de Apoio do Aeroporto Internacional do Rio de Janeiro - Ilha do Governador - RJ', marginLeft, FOOT_Y);
        }

        var head = [['Matrícula','Funcionário','Setor','Data de Participação','Assinatura']];
        var body = base.map(function(r){ return [ r.Matricula||'', r.Nome||'', r.Setor||'', formatTimestamp(r.Timestamp)||'', '' ]; });

        doc.autoTable({
          startY: marginTop + LINE*4,
          head: head,
          body: body,
          margin: { left: marginLeft, right: marginRight, top: marginTop, bottom: marginBottom },
          tableWidth: usableWidth,
          styles: { font:'helvetica', fontSize:8, cellPadding:4, valign:'middle', overflow:'linebreak' },
          headStyles: { fillColor:[33,150,243], textColor:255, halign:'center' },
          didParseCell: function(d){ if(d.section==='body' && d.column.index===4){ d.cell.height = Math.max(d.cell.height, SIG_MIN_H); } },
          didDrawCell: function(d){ if(d.section==='body' && d.column.index===4){ var i=d.row.index; var sig = base[i].AssinaturaPNG; if(sig){ var pad=2; var x=d.cell.x+pad, y=d.cell.y+pad; var w=d.cell.width-pad*2, h=d.cell.height-pad*2; try{ doc.addImage(sig,'PNG',x,y,w,h);}catch(e){} } } },
          didDrawPage: function(hk){ var pageNumber = (hk && hk.pageNumber)? hk.pageNumber : (doc.internal.getCurrentPageInfo && doc.internal.getCurrentPageInfo().pageNumber) || 1; var totalPages = doc.internal.getNumberOfPages(); drawHeaderFooter(pageNumber, totalPages); }
        });

        var total = doc.internal.getNumberOfPages();
        for (var pi = 1; pi <= total; pi++) {
          doc.setPage(pi);
          doc.setFont('helvetica','italic'); doc.setFontSize(8);
          var FOOT_Y = pageHeight - 22;
          var label = 'Página ' + pi + ' de ' + total;
          doc.text(label, pageWidth - marginRight, FOOT_Y + 2, { align:'right' });
        }

        doc.save('DSS_GIG_Relatorio.pdf');
      });
    });
  }

  // ====== ZIP OFFLINE ======
  function gerarPacoteOffline(){
    if(!window.JSZip){ alert('JSZip não carregou.'); return; }
    var baseSource = (window.registrosFiltrados && window.registrosFiltrados.length)? window.registrosFiltrados : window.registros;
    if(!baseSource || !baseSource.length){ alert('Nenhum dado para empacotar. Faça uma busca primeiro.'); return; }
    var base = baseSource.slice().sort(function(a,b){ return String(a.Nome||'').localeCompare(String(b.Nome||''),'pt-BR',{sensitivity:'base'}); });

    fetchTreinamentos().then(function(tList){
      var titulos=[]; var seen={};
      for (var i=0;i<base.length;i++){ var t=base[i].TituloVideo; if(t && !seen[t]){ seen[t]=1; titulos.push(t);} }
      var tituloSemana = titulos.length? titulos.join('; ') : '-';
      var semanasISO=[]; var sseen={}; for (var j=0;j<base.length;j++){ var s=base[j].SemanaISO; if(s && !sseen[s]){ sseen[s]=1; semanasISO.push(s);} }
      var assuntosCabecalho=''; if(tList && tList.length){ var setISO={}; for (var k=0;k<semanasISO.length;k++){ setISO[semanasISO[k]]=1;} var hit=null; for(var u=0;u<tList.length;u++){ var t2=tList[u]; if(setISO[String(t2['SemanaISO'])]){hit=t2;break;} } if(!hit && titulos.length){ for(var w=0; w<tList.length; w++){ var t3=tList[w]; if(String(t3['Titulo']).trim()===titulos[0]){ hit=t3; break; } } } if(hit && hit['Assuntos']) assuntosCabecalho=String(hit['Assuntos']); }

      var zip = new JSZip(); var folder = zip.folder('DSS_GIG_offline');
      var payload = { base: base, tituloSemana: tituloSemana, assuntosCabecalho: assuntosCabecalho };
      folder.file('data.json', JSON.stringify(payload, null, 2), {compression:'DEFLATE'});

      if(window.LOGO_DATAURL){ var b64 = window.LOGO_DATAURL.split(',')[1]||window.LOGO_DATAURL; var byteChars = atob(b64); var arr = new Uint8Array(byteChars.length); for(var k2=0;k2<byteChars.length;k2++){ arr[k2]=byteChars.charCodeAt(k2);} var blobLogo = new Blob([arr], {type:'image/png'}); folder.file('logo.png', blobLogo); }

      function fetchText(url){ return fetch(url).then(function(r){ return r.text(); }); }
      Promise.all([
        fetchText('https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js'),
        fetchText('https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js')
      ]).then(function(arrTxt){
        var vendor = folder.folder('vendor');
        vendor.file('jspdf.umd.min.js', arrTxt[0]);
        vendor.file('jspdf.plugin.autotable.min.js', arrTxt[1]);

        var offlineHTML = ''+
          '<!DOCTYPE html>\n'+
          '<html lang="pt-BR"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>'+
          '<title>DSS GIG — Relatório Offline</title>'+
          '<style>body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:24px;} .btn{padding:10px 14px;border-radius:8px;border:1px solid #ddd;cursor:pointer;} .muted{color:#6b7280}</style>'+
          '<script src="vendor/jspdf.umd.min.js"><\/script>'+
          '<script src="vendor/jspdf.plugin.autotable.min.js"><\/script>'+
          '</head>'+
          '<body>'+
          '<h1>Relatório Offline — DSS GIG</h1>'+
          '<p class="muted">Este pacote foi gerado a partir de um snapshot. Você pode gerar o PDF abaixo, sem internet.</p>'+
          '<button id="btnGerar" class="btn">Gerar PDF</button>'+
          '<script>'+
          '(function(){'+
            'function pad(n){ return String(n).padStart(2,\'0\'); }'+
            'function loadLogo(cb){ fetch(\'logo.png\').then(function(r){ if(!r.ok) return cb(null); return r.blob(); }).then(function(b){ if(!b) return cb(null); var fr=new FileReader(); fr.onload=function(){ cb(fr.result); }; fr.readAsDataURL(b); }).catch(function(){ cb(null); }); }'+
            'document.getElementById(\'btnGerar\').onclick = function(){ fetch(\'data.json\').then(function(res){ return res.json(); }).then(function(snap){ var base = Array.isArray(snap.base)? snap.base : []; var tituloSemana = snap.tituloSemana || \"-\"; var assuntosCabecalho = snap.assuntosCabecalho || \"\"; var jsPDF = window.jspdf.jsPDF; var doc = new jsPDF({ orientation:\'portrait\', unit:\'pt\', format:\'a4\' }); var marginLeft=48, marginRight=48, marginTop=150, marginBottom=88; var pageWidth=doc.internal.pageSize.getWidth(), pageHeight=doc.internal.pageSize.getHeight(); var usableWidth=pageWidth - marginLeft - marginRight; var LOGO_W=120, LOGO_H=52; var LINE=12; var SIG_MIN_H=112; function drawHeaderFooter(pageNumber,totalPages,LOGO){ try{ if(LOGO) doc.addImage(LOGO,\'PNG\', pageWidth - marginRight - LOGO_W, 28, LOGO_W, LOGO_H);}catch(e){} doc.setFont(\'helvetica\',\'bold\'); doc.setFontSize(18); doc.text(\'Diálogo Semanal de Segurança\', marginLeft, 48); doc.setFont(\'helvetica\',\'bold\'); doc.setFontSize(14); var semanaText=\'Semana: \'+(tituloSemana||\'-\'); var semanaLines=doc.splitTextToSize(semanaText, usableWidth - (LOGO_W + 12)); var ySemana=78; doc.text(semanaLines, marginLeft, ySemana); var y = ySemana + LINE * Math.max(1, semanaLines.length) + LINE; if(assuntosCabecalho && assuntosCabecalho.length){ doc.setFont(\'helvetica\',\'normal\'); doc.setFontSize(11); var as=doc.splitTextToSize(\'Assuntos: \'+assuntosCabecalho, usableWidth); doc.text(as, marginLeft, y); y += LINE * Math.max(1, as.length); } var dt=new Date(); var linhaDH='Relatório gerado em '+pad(dt.getDate())+'/'+pad(dt.getMonth()+1)+'/'+dt.getFullYear()+' às '+pad(dt.getHours())+':'+pad(dt.getMinutes()); doc.setFont(\'helvetica\',\'normal\'); doc.setFontSize(10); doc.text(linhaDH, marginLeft, y + LINE); doc.setFont(\'helvetica\',\'normal\'); doc.setFontSize(7); var FOOT_LH=12, FOOT_Y=pageHeight-22; doc.text(\'Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG\', marginLeft, FOOT_Y - (FOOT_LH * 2)); doc.text(\'CNPJ 33.375.601/0001-38\', marginLeft, FOOT_Y - (FOOT_LH * 1)); doc.text(\'Rua P, S/N, Área de Apoio do Aeroporto Internacional do Rio de Janeiro - Ilha do Governador - RJ\', marginLeft, FOOT_Y); } var head=[[\'Matrícula\',\'Funcionário\',\'Setor\',\'Data de Participação\',\'Assinatura\']]; var body=base.map(function(r){ return [ r.Matricula||\'\', r.Nome||\'\', r.Setor||\'\', r.Timestamp||\'\', \"\" ]; }); loadLogo(function(LOGO){ doc.autoTable({ startY: marginTop + LINE*4, head: head, body: body, margin:{ left:marginLeft, right:marginRight, top:marginTop, bottom:marginBottom }, tableWidth: usableWidth, styles:{ font:\'helvetica\', fontSize:8, cellPadding:4, valign:\'middle\', overflow:\'linebreak\' }, headStyles:{ fillColor:[33,150,243], textColor:255, halign:\'center\' }, didParseCell:function(d){ if(d.section===\'body\' && d.column.index===4){ d.cell.height=Math.max(d.cell.height, SIG_MIN_H);} }, didDrawCell:function(d){ if(d.section===\'body\' && d.column.index===4){ var i=d.row.index; var sig=base[i].AssinaturaPNG; if(sig){ var pad2=2; var x=d.cell.x+pad2, y2=d.cell.y+pad2; var w=d.cell.width-pad2*2, h=d.cell.height-pad2*2; try{ doc.addImage(sig,\'PNG\',x,y2,w,h);}catch(e){} } } }, didDrawPage:function(hk){ var pageNumber=(hk && hk.pageNumber)? hk.pageNumber : (doc.internal.getCurrentPageInfo && doc.internal.getCurrentPageInfo().pageNumber) || 1; var totalPages=doc.internal.getNumberOfPages(); drawHeaderFooter(pageNumber,totalPages,LOGO); } }); var total=doc.internal.getNumberOfPages(); for (var pi=1; pi<=total; pi++){ doc.setPage(pi); doc.setFont(\'helvetica\',\'italic\'); doc.setFontSize(8); var FOOT_Y=pageHeight-22; var label='Página '+pi+' de '+total; doc.text(label, pageWidth - marginRight, FOOT_Y + 2, {align:\'right\'});} doc.save(\'DSS_GIG_Relatorio_OFFLINE.pdf\'); }); }); };'+
          '})();'+
          '<\/script>'+
          '</body></html>';

        folder.file('gestor_offline.html', offlineHTML);

        zip.generateAsync({type:'blob'}).then(function(blob){
          function pad(n){return String(n).padStart(2,'0');}
          var now = new Date();
          var stamp = now.getFullYear()+''+pad(now.getMonth()+1)+''+pad(now.getDate())+'_'+pad(now.getHours())+''+pad(now.getMinutes());
          saveAs(blob, 'DSS_GIG_offline_'+stamp+'.zip');
        });
      }).catch(function(err){ console.error(err); alert('Falha ao gerar o pacote offline.'); });
    });
  }

  // ====== Novo funcionário (prompt simples) ======
  function novoFuncionarioViaPrompt(){
    var status = document.getElementById('status');
    try{
      var mRaw = prompt('Nova matrícula (5 dígitos, apenas números):'); if(mRaw===null) return; mRaw=(mRaw||'').replace(/\D/g,'');
      while(!/^\d{5}$/.test(mRaw)){ mRaw = prompt('Matrícula inválida. Informe 5 dígitos (ex.: 12345):', mRaw); if(mRaw===null) return; mRaw=(mRaw||'').replace(/\D/g,''); }
      var matricula = mRaw;
      var nome = prompt('Nome completo:'); if(nome===null) return; nome=(nome||'').trim(); if(!nome){ alert('Nome é obrigatório.'); return; }
      var setor = prompt('Setor (opcional):'); if (setor===null) setor=''; setor=(setor||'').trim();
      var ok = confirm('Confirmar cadastro?\n\nMatrícula: '+matricula+'\nNome: '+nome+'\nSetor: '+(setor||'-')+'\nAtivo: TRUE'); if(!ok){ status.innerHTML='<div class="warn">Operação cancelada.</div>'; return; }
      var payload = { matricula: matricula, nome: nome, setor: setor, ativo: true };
      status.innerHTML = '<div class="warn">Enviando novo funcionário...</div>';
      fetch('/api/gas?action=addFuncionario',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) })
      .then(function(r){ return r.json(); })
      .then(function(data){ if(!data || !data.ok) throw new Error('Falha'); status.innerHTML = '<div class="ok">Funcionário incluído com sucesso.</div>'; })
      .catch(function(){ status.innerHTML = '<div class="error">Erro ao incluir funcionário.</div>'; });
    }catch(err){ status.innerHTML = '<div class="error">Erro inesperado.</div>'; }
  }

  // ====== Eventos ======
  document.getElementById('btnBuscar').addEventListener('click', buscar);
  document.getElementById('btnXLS').addEventListener('click', gerarXLS);
  document.getElementById('btnPDF').addEventListener('click', gerarPDF);
  document.getElementById('btnZIP').addEventListener('click', gerarPacoteOffline);
  document.getElementById('btnAddFunc').addEventListener('click', novoFuncionarioViaPrompt);
  ['fMat','fNome','fDataInicio','fDataFinal','fSemanaTitulo'].forEach(function(id){ var el=document.getElementById(id); el.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); buscar(); } });});

  // ====== Inicialização ======
  popularSemanas();
})();
</script>
</body>
</html>
