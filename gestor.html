<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DSS GIG — Painel do Gestor</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo" />
  <link rel="stylesheet" href="styles.css" />
  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <!-- XLSX (SheetJS) para gerar Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    .filters-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:640px){ .filters-grid { grid-template-columns:1fr; } }
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .site-header { box-shadow: none; }
      .card { box-shadow: none; border:1px solid #999; }
      .actions button { display:none; }
    }
    /* NOVOS FILTROS e CORES (complementa styles.css) */
    .filters-inline { display:flex; flex-wrap:wrap; gap:12px; margin-top:12px; }
    .filters-inline .row { display:flex; flex-direction:column; min-width:200px; }
    .actions { display:flex; align-items:center; gap:8px; margin-top:12px; }
    .sig-img { height:48px; object-fit:contain; }
  </style>
  <link rel="shortcut icon" href="icone lsg.ico">
</head>
<body>
<header class="site-header">
  <img src="logo lsg.png" alt="logo LSG" />
  <h1>Painel do Gestor — DSS GIG</h1>
  <p class="subtitle">Busque e gere relatórios em PDF/XLS (otimizado para impressão)</p>
</header>

<main class="container">
  <section class="card">
    <h2>Filtros</h2>

    <!-- Linha original (mantida) -->
    <div class="filters-grid">
      <div class="row">
        <label for="fMat">Matrícula</label>
        <input type="text" id="fMat" placeholder="Ex.: 12345" />
      </div>
      <div class="row">
        <label for="fNome">Nome</label>
        <input type="text" id="fNome" placeholder="Nome do colaborador" />
      </div>
      <div class="row">
        <label for="fSem">Semana (YYYY-Www)</label>
        <input type="text" id="fSem" placeholder="Ex.: 2026-W03" />
      </div>
    </div>

    <!-- NOVA LINHA: Data Início, Data Final e Semana=TituloVideo -->
    <div class="filters-inline">
      <div class="row">
        <label for="fDataInicio">Data Início</label>
        <input type="date" id="fDataInicio" />
      </div>
      <div class="row">
        <label for="fDataFinal">Data Final</label>
        <input type="date" id="fDataFinal" />
      </div>
      <div class="row">
        <label for="fSemanaTitulo">Semana</label>
        <!-- Atenção: rótulo 'Semana', conteúdo = TituloVideo (da aba Registros) -->
        <select id="fSemanaTitulo">
          <option value="">Todas</option>
        </select>
      </div>
    </div>

    <!-- Ordem dos botões: Buscar (azul) -> XLS (cinza) -> PDF (cinza) -> Novo Funcionário (cinza, afastado) -->
    <div class="actions">
      <button id="btnBuscar" class="primary">Buscar</button>
      <button id="btnXLS" class="secondary">Gerar XLS</button>
      <button id="btnPDF" class="secondary">Gerar PDF</button>
      <button id="btnAddFunc" class="danger">Novo Funcionário</button>
    </div>

    <div id="status" class="message"></div>
  </section>

  <section class="card">
    <h2>Resultados</h2>
    <div class="table-wrapper">
      <table id="tbl" class="table">
        <thead>
          <tr>
            <th>Matrícula</th>
            <th>Funcionário</th>
            <th>Setor</th>
            <th>Semana</th>
            <th>Título do Vídeo</th>
            <th>Data de participação</th>
            <th>Assinatura</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="site-footer">
  <small>© Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG</small>
</footer>

<script>
  const API_BASE = '/api/gas';
  const LOGO_SRC = 'logo lsg.png';
  let LOGO_DATAURL = '';

  // Estado
  let registros = [];          // brutos
  let registrosFiltrados = []; // após filtros + deduplicação

  // Carrega logo (para PDF)
  function loadLogoAsDataURL() {
    return new Promise(resolve => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        try {
          const c = document.createElement('canvas');
          c.width = img.width; c.height = img.height;
          c.getContext('2d').drawImage(img, 0, 0);
          LOGO_DATAURL = c.toDataURL('image/png');
          resolve(LOGO_DATAURL);
        } catch(e){ resolve(LOGO_DATAURL = ''); }
      };
      img.onerror = () => resolve(LOGO_DATAURL = '');
      img.src = LOGO_SRC;
    });
  }

  // Eventos principais
  document.getElementById('btnBuscar').addEventListener('click', buscar);
  document.getElementById('btnPDF').addEventListener('click', gerarPDF);
  document.getElementById('btnXLS').addEventListener('click', gerarXLS);
  document.getElementById('btnAddFunc').addEventListener('click', novoFuncionarioViaPrompt);

  // Enter nos campos de filtro => Buscar
  ['fMat','fNome','fSem','fDataInicio','fDataFinal','fSemanaTitulo'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); buscar(); }
    });
  });

  // Popular dropdown "Semana" com TituloVideo a partir de /registros
  (async function popularTitulos(){
    try{
      const res = await fetch(API_BASE + '?action=registros');
      const data = await res.json();
      if (!data.ok) return;
      const all = Array.isArray(data.data) ? data.data : [];
      const titulos = Array.from(new Set(all.map(r => (r.TituloVideo||'').trim()).filter(Boolean)))
        .sort((a,b)=>a.localeCompare(b,'pt-BR',{sensitivity:'base'}));
      const sel = document.getElementById('fSemanaTitulo');
      sel.innerHTML = '<option value="">Todas</option>' +
        titulos.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    }catch(e){}
  })();

  // Buscar + filtros locais + deduplicação
  async function buscar(){
    const status = document.getElementById('status'); status.innerHTML='';
    const fMat = document.getElementById('fMat').value.trim();
    const fNome = document.getElementById('fNome').value.trim();
    const fSemISO = document.getElementById('fSem').value.trim();
    const fTitulo = document.getElementById('fSemanaTitulo').value.trim(); // TituloVideo
    const fDataI = document.getElementById('fDataInicio').value;
    const fDataF = document.getElementById('fDataFinal').value;

    // Filtros suportados pela API
    const qs = new URLSearchParams({ action:'registros' });
    if (fMat) qs.append('matricula', fMat);
    if (fNome) qs.append('nome', fNome);
    if (fSemISO) qs.append('semana', fSemISO);
    try{
      const res = await fetch(API_BASE + '?' + qs.toString());
      let data; try{ data = await res.json(); }catch{ data = { ok:false, error:'Resposta não-JSON do proxy', status:res.status }; }
      if (!data.ok) throw new Error(data.error || 'Erro ao buscar');
      registros = Array.isArray(data.data) ? data.data : [];

      // Filtros locais adicionais: Data Início/Final e TituloVideo
      const di = normalizarDataInput(fDataI);           // UTC 00:00
      const df = fimDoDia(normalizarDataInput(fDataF)); // UTC 23:59:59
      let lista = registros.filter(r => {
        const ts = parseTimestamp(r.Timestamp);
        if (!ts) return false;
        if (di && ts < di) return false;
        if (df && ts > df) return false;
        if (fTitulo && (r.TituloVideo || '') !== fTitulo) return false;
        return true;
      });

      // Deduplicação por (Matricula + SemanaISO + TituloVideo), mantendo a PRIMEIRA (timestamp mais antigo)
      const mapa = new Map();
      for (const r of lista) {
        const chave = `${r.Matricula||''}__${r.SemanaISO||''}__${r.TituloVideo||''}`;
        const atual = mapa.get(chave);
        const novoTS = parseTimestamp(r.Timestamp);
        if (!atual) {
          mapa.set(chave, r);
        } else {
          const antigoTS = parseTimestamp(atual.Timestamp);
          if (novoTS && antigoTS && novoTS < antigoTS) mapa.set(chave, r);
        }
      }
      registrosFiltrados = Array.from(mapa.values())
        .sort((a,b)=> (parseTimestamp(a.Timestamp)||0)-(parseTimestamp(b.Timestamp)||0));

      renderTabela(registrosFiltrados);
      status.innerHTML = '<div class="ok">Busca concluída: ' + registrosFiltrados.length + ' registro(s) após deduplicação.</div>';
    }catch(err){
      status.innerHTML = '<div class="error">Falha na consulta.</div>';
    }
  }

  function renderTabela(list){
    const tbody = document.getElementById('tbody'); tbody.innerHTML='';
    if(!list || list.length===0){ tbody.innerHTML='<tr><td colspan="7" class="muted">Sem resultados</td></tr>'; return; }
    tbody.innerHTML = list.map(r=>{
      const dataPart = formatTimestamp(r.Timestamp);
      const assinatura = r.AssinaturaPNG ? '<img class="sig-img" src="'+r.AssinaturaPNG+'" alt="Assinatura" />' : '-';
      return `
        <tr>
          <td>${escapeHtml(r.Matricula||'')}</td>
          <td>${escapeHtml(r.Nome||'')}</td>
          <td>${escapeHtml(r.Setor||'')}</td>
          <td>${escapeHtml(r.SemanaISO||'')}</td>
          <td>${escapeHtml(r.TituloVideo||'')}</td>
          <td>${escapeHtml(dataPart)}</td>
          <td>${assinatura}</td>
        </tr>`;
    }).join('');
  }

  // XLSX
  function gerarXLS(){
    const base = (registrosFiltrados && registrosFiltrados.length) ? registrosFiltrados : registros;
    if(!base || !base.length) { alert('Faça uma busca primeiro.'); return; }
    const linhas = base.map(r => ({
      'Matrícula': r.Matricula || '',
      'Funcionário': r.Nome || '',
      'Setor': r.Setor || '',
      'Semana (ISO)': r.SemanaISO || '',
      'Título do Vídeo': r.TituloVideo || '',
      'Data de participação': formatTimestamp(r.Timestamp)
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(linhas);
    XLSX.utils.book_append_sheet(wb, ws, 'Relatório');
    XLSX.writeFile(wb, nomeArquivo('xlsx'));
  }

  // PDF (assinatura maior)
  async function gerarPDF(){
    await loadLogoAsDataURL();
    const base = (registrosFiltrados && registrosFiltrados.length) ? registrosFiltrados : registros;
    if(!base || !base.length){ alert('Nenhum dado para gerar PDF.'); return; }
    const titulos = [...new Set(base.map(r=>r.TituloVideo).filter(Boolean))];
    const tituloSemana = titulos.length ? titulos.join('; ') : '-';

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ orientation:'portrait', unit:'pt', format:'a4' });
    const marginLeft = 48, marginRight = 48, marginTop = 120, marginBottom = 88;
    const pageWidth = doc.internal.pageSize.getWidth();
    const usableWidth = pageWidth - marginLeft - marginRight;
    const LOGO_W = 120, LOGO_H = 52;

    function drawHeaderFooter(){
      try{ if(LOGO_DATAURL) doc.addImage(LOGO_DATAURL,'PNG', pageWidth - marginRight - LOGO_W, 28, LOGO_W, LOGO_H); }catch(e){}
      doc.setFont('helvetica','bold'); doc.setFontSize(18);
      doc.text('Diálogo Semanal de Segurança', marginLeft, 48);
      doc.setFont('helvetica','bold'); doc.setFontSize(14);
      const headerText = 'Semana: ' + (tituloSemana || '-');
      doc.text(doc.splitTextToSize(headerText, usableWidth - (LOGO_W + 12)), marginLeft, 78);
      const pageHeight = doc.internal.pageSize.getHeight();
      const lineH = 14; const startY = pageHeight - marginBottom + 10;
      const generatedAt = new Date().toLocaleString('pt-BR');
      doc.setFont('helvetica','italic'); doc.setFontSize(9);
      doc.text('Gerado em: ' + generatedAt, marginLeft, startY);
      doc.setFont('helvetica','normal'); doc.setFontSize(9);
      doc.text('Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG', marginLeft, startY + lineH);
      doc.text('CNPJ 33.375.601/0001-38', marginLeft, startY + 2*lineH);
      doc.text('Rua P, S/N, Área de Apoio do Aeroporto Internacional do Rio de Janeiro - Ilha do Governador - RJ', marginLeft, startY + 3*lineH);
    }

    const head = [['Matrícula','Funcionário','Setor','Data de Participação','Assinatura']];
    const body = base.map(r => [
      r.Matricula||'', r.Nome||'', r.Setor||'', formatTimestamp(r.Timestamp)||'', ''
    ]);

    const weights = { matricula:0.12, funcionario:0.30, setor:0.18, data:0.22, assinatura:0.18 };
    const norm = Object.values(weights).reduce((a,b)=>a+b,0) || 1;
    const W = {
      matricula : Math.floor((weights.matricula / norm) * usableWidth),
      funcionario: Math.floor((weights.funcionario/ norm) * usableWidth),
      setor : Math.floor((weights.setor / norm) * usableWidth),
      data : Math.floor((weights.data / norm) * usableWidth),
      assinatura : Math.floor((weights.assinatura / norm) * usableWidth),
    };
    const sumW = W.matricula + W.funcionario + W.setor + W.data + W.assinatura;
    if (sumW !== usableWidth) W.assinatura += (usableWidth - sumW);

    doc.autoTable({
      startY: marginTop,
      head, body,
      margin: { left: marginLeft, right: marginRight, top: marginTop, bottom: marginBottom },
      tableWidth: usableWidth,
      styles: { font:'helvetica', fontSize:9, cellPadding:4, valign:'middle', overflow:'linebreak' },
      headStyles: { fillColor:[33,150,243], textColor:255, halign:'center' },
      columnStyles: {
        0: { cellWidth: W.matricula, halign:'left' },
        1: { cellWidth: W.funcionario, halign:'left' },
        2: { cellWidth: W.setor, halign:'left' },
        3: { cellWidth: W.data, halign:'left' },
        4: { cellWidth: W.assinatura, halign:'center' }
      },
      didParseCell: (data) => {
        if (data.section === 'body' && data.column.index === 4) {
          data.cell.height = Math.max(data.cell.height, 32); // assinatura maior
        }
      },
      didDrawCell: (data) => {
        if (data.section === 'body' && data.column.index === 4) {
          const i = data.row.index;
          const sig = base[i].AssinaturaPNG;
          if (sig) {
            const pad = 2;
            const x = data.cell.x + pad;
            const y = data.cell.y + pad;
            const w = data.cell.width - pad * 2;
            const h = data.cell.height - pad * 2;
            try { doc.addImage(sig, 'PNG', x, y, w, h); } catch(e){}
          }
        }
      },
      didDrawPage: drawHeaderFooter
    });

    doc.save(nomeArquivo('pdf'));
  }

  // Inclusão de novo funcionário (mesmo fluxo de antes)
  async function novoFuncionarioViaPrompt(){
    const status = document.getElementById('status');
    try{
      let mRaw = prompt('Nova matrícula (5 dígitos, apenas números):');
      if (mRaw === null) return;
      mRaw = (mRaw||'').replace(/\D/g,'');
      while (!/^\d{5}$/.test(mRaw)) {
        mRaw = prompt('Matrícula inválida. Informe 5 dígitos (ex.: 12345):', mRaw);
        if (mRaw === null) return;
        mRaw = (mRaw||'').replace(/\D/g,'');
      }
      const matricula = mRaw;
      let nome = prompt('Nome completo:');
      if (nome === null) return;
      nome = (nome||'').trim();
      if (!nome) { alert('Nome é obrigatório.'); return; }
      let setor = prompt('Setor (opcional):');
      if (setor === null) setor = '';
      setor = (setor||'').trim();
      const ok = confirm(`Confirmar cadastro?\n\nMatrícula: ${matricula}\nNome: ${nome}\nSetor: ${setor||'-'}\nAtivo: TRUE`);
      if (!ok) { status.innerHTML = '<div class="warn">Operação cancelada.</div>'; return; }
      const payload = { matricula, nome, setor, ativo: true };
      status.innerHTML = '<div class="warn">Enviando novo funcionário...</div>';
      const res = await fetch(API_BASE+'?action=addFuncionario',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      let data; try{ data = await res.json(); } catch{ data = { ok:false, error:'Resposta não-JSON', status: res.status }; }
      if(!data.ok) throw new Error(data.error || 'Falha ao incluir funcionário');
      status.innerHTML = '<div class="ok">Funcionário incluído com sucesso.</div>';
    }catch(err){
      status.innerHTML = '<div class="error">'+ (err && err.message ? err.message : 'Erro ao incluir funcionário') +'</div>';
    }
  }

  // Utils
  function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }
  function nomeArquivo(ext){
    const hoje = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    return `DSS_GIG_Relatorio_${hoje.getFullYear()}-${pad(hoje.getMonth()+1)}-${pad(hoje.getDate())}.${ext}`;
  }
  function normalizarDataInput(v) {
    if (!v) return null; // 'YYYY-MM-DD'
    const [yyyy, mm, dd] = v.split('-').map(Number);
    return new Date(Date.UTC(yyyy, mm - 1, dd, 0, 0, 0)); // UTC 00:00
  }
  function fimDoDia(dIniUTC) {
    if (!dIniUTC) return null;
    return new Date(dIniUTC.getTime() + 24*60*60*1000 - 1);
  }
  function parseTimestamp(valor){
    if (!valor) return null;
    let d = new Date(valor);
    if (!Number.isNaN(d.getTime())) return d;
    // tenta DD/MM/YYYY HH:MM[:SS]
    const rx = /^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/;
    const m = String(valor).trim().match(rx);
    if (m){
      const dd = +m[1], mm = +m[2], yy = +m[3];
      const hh = +(m[4] ?? 0), mi = +(m[5] ?? 0), ss = +(m[6] ?? 0);
      return new Date(yy, mm-1, dd, hh, mi, ss);
    }
    return null;
  }
  function formatTimestamp(ts){
    const d = parseTimestamp(ts);
    if (!d) return String(ts||'');
    const pad = (n)=>String(n).padStart(2,'0');
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
</script>
</body>
</html>
