<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DSS GIG — Painel do Gestor</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=" />
<link rel="stylesheet" href="styles.css" />
<!-- jsPDF + AutoTable para gerar PDF -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
<header class="site-header">
  <h1>Painel do Gestor — DSS GIG</h1>
  <p class="subtitle">Busque e gere relatórios em PDF</p>
</header>

<main class="container">
  <section class="card">
    <h2>Filtros</h2>
    <div class="row">
      <label for="fMat">Matrícula</label>
      <input type="text" id="fMat" placeholder="Ex.: 12345" />
    </div>
    <div class="row">
      <label for="fNome">Nome</label>
      <input type="text" id="fNome" placeholder="Nome do colaborador" />
    </div>
    <div class="row">
      <label for="fSem">Semana (YYYY-Www)</label>
      <input type="text" id="fSem" placeholder="Ex.: 2026-W03" />
    </div>
    <div class="row">
      <label for="logoUpload">Logo da empresa (opcional para o PDF)</label>
      <input type="file" id="logoUpload" accept="image/*" />
    </div>
    <div class="actions">
      <button id="btnBuscar" class="primary">Buscar</button>
      <button id="btnPDF" class="secondary">Gerar PDF</button>
    </div>
    <div id="status" class="message"></div>
  </section>

  <section class="card">
    <h2>Resultados</h2>
    <div class="table-wrapper">
      <table id="tbl" class="table">
        <thead>
          <tr>
            <th>Matrícula</th>
            <th>Funcionário</th>
            <th>Setor</th>
            <th>Semana</th>
            <th>Data de participação</th>
            <th>Assinatura</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="site-footer">
  <small>© Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG</small>
</footer>

<script>
const API_BASE = '/api/gas';

let registros = [];
let logoDataURL = null;

document.getElementById('logoUpload').addEventListener('change', (ev) => {
  const file = ev.target.files[0]; if (!file) return;
  const reader = new FileReader(); reader.onload = () => { logoDataURL = reader.result; };
  reader.readAsDataURL(file);
});

document.getElementById('btnBuscar').addEventListener('click', buscar);
document.getElementById('btnPDF').addEventListener('click', gerarPDF);

async function buscar() {
  const status = document.getElementById('status'); status.innerHTML='';
  const matricula = document.getElementById('fMat').value.trim();
  const nome = document.getElementById('fNome').value.trim();
  const semana = document.getElementById('fSem').value.trim();

  const qs = new URLSearchParams({ action:'registros' });
  if (matricula) qs.append('matricula', matricula);
  if (nome) qs.append('nome', nome);
  if (semana) qs.append('semana', semana);

  try {
    const res = await fetch(API_BASE + '?' + qs.toString());
    let data; try { data = await res.json(); } catch { data = { ok:false, error:'Resposta não-JSON', status: res.status }; }
    if (!data.ok) throw new Error(data.error || 'Erro ao buscar');
    registros = data.data || [];
    renderTabela(registros);
    status.innerHTML = '<div class="ok">Busca concluída: ' + registros.length + ' registro(s).</div>';
  } catch (err) {
    status.innerHTML = '<div class="error">Falha na consulta.</div>';
  }
}

function renderTabela(list) {
  const tbody = document.getElementById('tbody'); tbody.innerHTML='';
  if (!list || list.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="muted">Sem resultados</td></tr>'; return; }
  list.forEach(r => {
    const tr = document.createElement('tr');
    const dataPart = formatTimestamp(r.Timestamp);
    tr.innerHTML = `
      <td>${r.Matricula || ''}</td>
      <td>${r.Nome || ''}</td>
      <td>${r.Setor || ''}</td>
      <td>${r.SemanaISO || ''}</td>
      <td>${dataPart}</td>
      <td>${r.AssinaturaPNG ? '<img class="sig-img" src="'+r.AssinaturaPNG+'" alt="Assinatura" />' : '-'}</td>`;
    tbody.appendChild(tr);
  });
}

function formatTimestamp(ts) {
  try { const d = new Date(ts); if (!isNaN(d.getTime())) return d.toLocaleString('pt-BR'); } catch(e){}
  return String(ts || '');
}

async function gerarPDF() {
  if (!registros || registros.length === 0) { alert('Nenhum dado para gerar PDF.'); return; }
  const semanaEscolhida = (document.getElementById('fSem').value || '').trim();

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ orientation: 'portrait', unit: 'pt', format: 'a4' });

  const marginLeft = 40, marginTop = 50; let y = marginTop;
  if (logoDataURL) { try { doc.addImage(logoDataURL, 'PNG', marginLeft, y - 10, 80, 40); } catch(e) {} }
  doc.setFont('helvetica', 'bold'); doc.setFontSize(16);
  doc.text('Diálogo Semanal de Segurança', marginLeft + (logoDataURL ? 90 : 0) + 10, y + 5);

  doc.setFont('helvetica', 'normal'); doc.setFontSize(12);
  if (semanaEscolhida) { doc.text('Semana: ' + semanaEscolhida, marginLeft, y + 30); }
  else {
    const sem = [...new Set(registros.map(r => r.SemanaISO).filter(Boolean))].join(', ');
    doc.text('Semana: ' + (sem || '-'), marginLeft, y + 30);
  }
  y += 50;

  const head = [['Matrícula','Funcionário','Setor','Data de participação','Assinatura']];
  const body = registros.map(r => [ r.Matricula || '', r.Nome || '', r.Setor || '', formatTimestamp(r.Timestamp) || '', '' ]);

  doc.autoTable({
    startY: y, head: head, body: body,
    styles: { font: 'helvetica', fontSize: 10, cellPadding: 6, valign: 'middle' },
    headStyles: { fillColor: [33,150,243], textColor: 255, halign: 'center' },
    columnStyles: { 0: { cellWidth: 80 }, 1: { cellWidth: 150 }, 2: { cellWidth: 100 }, 3: { cellWidth: 140 }, 4: { cellWidth: 120 } },
    didDrawCell: function (data) {
      if (data.section === 'body' && data.column.index === 4) {
        const i = data.row.index; const sig = registros[i].AssinaturaPNG;
        if (sig) { try { doc.addImage(sig, 'PNG', data.cell.x + 8, data.cell.y + 4, 100, 26); } catch(e){} }
      }
    }
  });

  let afterTableY = (doc.lastAutoTable && doc.lastAutoTable.finalY ? doc.lastAutoTable.finalY : y) + 20;
  const generatedAt = new Date().toLocaleString('pt-BR');
  doc.setFont('helvetica', 'italic'); doc.setFontSize(10);
  doc.text('Relatório gerado em: ' + generatedAt, 40, afterTableY);
  afterTableY += 30;

  doc.setFont('helvetica', 'normal'); doc.setFontSize(9);
  const footerLines = [
    'Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG',
    'CNPJ 33.375.601/0001-38',
    'Rua P, S/N, Área de Apoio do Aeroporto Internacional do Rio de Janeiro - Ilha do Governador - RJ'
  ];
  footerLines.forEach((line, idx) => doc.text(line, 40, afterTableY + (idx * 14)));

  doc.save('Relatorio_Dialogo_Semanal_de_Seguranca.pdf');
}
</script>
</body>
</html>
