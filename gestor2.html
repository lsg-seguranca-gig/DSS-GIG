<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DSS GIG — Painel do Gestor</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo" />
  <link rel="stylesheet" href="styles.css" />
  <!-- jsPDF + AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.min.js"></script>
  <!-- XLSX (SheetJS) para gerar Excel -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    /* Fonte única na página (mantém tamanhos atuais do layout) */
    html, body, button, input, select, table, th, td, label, .card, .site-header {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif;
    }

    /* ===== Layout dos Filtros (igual ao mock) ===== */
    .filters-wrap { display:flex; flex-direction:column; gap:14px; }

    /* Linha 1: 2 colunas (Matrícula | Nome) */
    .filters-row-1 { display:grid; grid-template-columns: 1fr 1fr; gap:24px; }

    /* Linha 2: 3 colunas (Semana | Data Inicial | Data Final) */
    .filters-row-2 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:24px; }

    /* Campos consistentes */
    .filters-wrap .row { display:flex; flex-direction:column; }
    .filters-wrap label { font-size:14px; margin-bottom:6px; color:#374151; }
    .filters-wrap input[type="text"],
    .filters-wrap input[type="date"],
    .filters-wrap select { height:40px; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:#fff; color:#111827; box-sizing:border-box; width:100%; }

    /* Ações: três à esquerda, "Novo Funcionário" separado à direita */
    .actions{ display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-top:6px; }
    .actions-left{ display:flex; gap:8px; flex-wrap:wrap; }
    .actions-right{ display:flex; gap:8px; }

    /* Responsivo */
    @media (max-width: 900px){
      .filters-row-1{ grid-template-columns: 1fr; }
      .filters-row-2{ grid-template-columns: 1fr; }
      .actions{ justify-content:flex-start; gap:8px; }
      .actions-right{ margin-top:6px; }
    }

    /* Tabela/print mantidos */
    .sig-img { height:48px; object-fit:contain; }
    @media print {
      body { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
      .site-header { box-shadow: none; }
      .card { box-shadow: none; border:1px solid #999; }
      .actions button { display:none; }
    }
  </style>
  <link rel="shortcut icon" href="icone lsg.ico">
</head>
<body>
<header class="site-header">
  <img src="logo lsg.png" alt="logo LSG" />
  <h1>Painel do Gestor — DSS GIG</h1>
  <p class="subtitle">Busque e gere relatórios em PDF/XLS (otimizado para impressão)</p>
</header>

<main class="container">
  <section class="card">
    <h2>Filtros</h2>

    <div class="filters-wrap">
      <!-- Linha 1 -->
      <div class="filters-row-1">
        <div class="row">
          <label for="fMat">Matrícula</label>
          <input type="text" id="fMat" placeholder="Ex.: 12345" />
        </div>
        <div class="row">
          <label for="fNome">Nome</label>
          <input type="text" id="fNome" placeholder="Nome do colaborador" />
        </div>
      </div>

      <!-- Linha 2 -->
      <div class="filters-row-2">
        <div class="row">
          <label for="fSemanaTitulo">Semana</label>
          <select id="fSemanaTitulo">
            <option value="">Todas</option>
          </select>
        </div>
        <div class="row">
          <label for="fDataInicio">Data Inicial</label>
          <input type="date" id="fDataInicio" />
        </div>
        <div class="row">
          <label for="fDataFinal">Data Final</label>
          <input type="date" id="fDataFinal" />
        </div>
      </div>

      <!-- Botões (esquerda: 3 / direita: Novo Funcionário) -->
      <div class="actions">
        <div class="actions-left">
          <button id="btnBuscar" class="primary">Buscar</button>
          <button id="btnXLS" class="secondary">Gerar XLS</button>
          <button id="btnPDF" class="secondary">Gerar PDF</button>
        </div>
        <div class="actions-right">
          <button id="btnAddFunc" class="secondary">Novo Funcionário</button>
        </div>
      </div>

      <div id="status" class="message"></div>
    </div>
  </section>

  <section class="card">
    <h2>Resultados</h2>
    <div class="table-wrapper">
      <table id="tbl" class="table">
        <thead>
          <tr>
            <th>Matrícula</th>
            <th>Funcionário</th>
            <th>Setor</th>
            <th>Semana</th>
            <th>Título do Vídeo</th>
            <th>Data de participação</th>
            <th>Assinatura</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </section>
</main>

<footer class="site-footer">
  <small>© Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG</small>
</footer>

<script>
  const API_BASE = '/api/gas';
  const LOGO_SRC = 'logo lsg.png';
  let LOGO_DATAURL = '';

  // Estado
  let registros = [];
  let registrosFiltrados = [];

  function loadLogoAsDataURL() {
    return new Promise(resolve => {
      const img = new Image();
      img.crossOrigin = 'anonymous';
      img.onload = () => {
        try {
          const c = document.createElement('canvas');
          c.width = img.width; c.height = img.height;
          c.getContext('2d').drawImage(img, 0, 0);
          LOGO_DATAURL = c.toDataURL('image/png');
          resolve(LOGO_DATAURL);
        } catch(e){ resolve(LOGO_DATAURL = ''); }
      };
      img.onerror = () => resolve(LOGO_DATAURL = '');
      img.src = LOGO_SRC;
    });
  }

  document.getElementById('btnBuscar').addEventListener('click', buscar);
  document.getElementById('btnPDF').addEventListener('click', gerarPDF);
  document.getElementById('btnXLS').addEventListener('click', gerarXLS);
  document.getElementById('btnAddFunc').addEventListener('click', novoFuncionarioViaPrompt);

  ['fMat','fNome','fDataInicio','fDataFinal','fSemanaTitulo'].forEach(id=>{
    const el = document.getElementById(id);
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); buscar(); }
    });
  });

  (async function popularTitulos(){
    try{
      const res = await fetch(API_BASE + '?action=registros');
      const data = await res.json();
      if (!data.ok) return;
      const all = Array.isArray(data.data) ? data.data : [];
      const titulos = Array.from(new Set(all.map(r => (r.TituloVideo||'').trim()).filter(Boolean)))
        .sort((a,b)=>a.localeCompare(b,'pt-BR',{sensitivity:'base'}));
      const sel = document.getElementById('fSemanaTitulo');
      sel.innerHTML = '<option value="">Todas</option>' +
        titulos.map(t => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join('');
    }catch(e){}
  })();

  async function buscar(){
    const status = document.getElementById('status'); status.innerHTML='';
    const fMat = document.getElementById('fMat').value.trim();
    const fNome = document.getElementById('fNome').value.trim();
    const fTitulo = document.getElementById('fSemanaTitulo').value.trim();
    const fDataI = document.getElementById('fDataInicio').value;
    const fDataF = document.getElementById('fDataFinal').value;

    const qs = new URLSearchParams({ action:'registros' });
    if (fMat) qs.append('matricula', fMat);
    if (fNome) qs.append('nome', fNome);

    try{
      const res = await fetch(API_BASE + '?' + qs.toString());
      let data; try{ data = await res.json(); }catch{ data = { ok:false, error:'Resposta não-JSON do proxy', status:res.status }; }
      if (!data.ok) throw new Error(data.error || 'Erro ao buscar');
      registros = Array.isArray(data.data) ? data.data : [];

      const di = normalizarDataInput(fDataI);
      const df = fimDoDia(normalizarDataInput(fDataF));
      let lista = registros.filter(r => {
        const ts = parseTimestamp(r.Timestamp);
        if (!ts) return false;
        if (di && ts < di) return false;
        if (df && ts > df) return false;
        if (fTitulo && (r.TituloVideo || '') !== fTitulo) return false;
        return true;
      });

      const mapa = new Map();
      for (const r of lista) {
        const chave = `${r.Matricula||''}__${r.SemanaISO||''}__${r.TituloVideo||''}`;
        const atual = mapa.get(chave);
        const novoTS = parseTimestamp(r.Timestamp);
        if (!atual) {
          mapa.set(chave, r);
        } else {
          const antigoTS = parseTimestamp(atual.Timestamp);
          if (novoTS && antigoTS && novoTS < antigoTS) mapa.set(chave, r);
        }
      }

      registrosFiltrados = Array.from(mapa.values())
        .sort((a,b)=> String(a.Nome||'').localeCompare(String(b.Nome||''),'pt-BR',{sensitivity:'base'}));

      renderTabela(registrosFiltrados);
      status.innerHTML = '<div class="ok">Busca concluída: ' + registrosFiltrados.length + ' registro(s) após deduplicação e ordenação.</div>';
    }catch(err){
      status.innerHTML = '<div class="error">Falha na consulta.</div>';
    }
  }

  function renderTabela(list){
    const tbody = document.getElementById('tbody'); tbody.innerHTML='';
    if(!list || list.length===0){ tbody.innerHTML='<tr><td colspan="7" class="muted">Sem resultados</td></tr>'; return; }
    tbody.innerHTML = list.map(r=>{
      const dataPart = formatTimestamp(r.Timestamp);
      const assinatura = r.AssinaturaPNG ? '<img class="sig-img" src="'+r.AssinaturaPNG+'" alt="Assinatura" />' : '-';
      return `
        <tr>
          <td>${escapeHtml(r.Matricula||'')}</td>
          <td>${escapeHtml(r.Nome||'')}</td>
          <td>${escapeHtml(r.Setor||'')}</td>
          <td>${escapeHtml(r.SemanaISO||'')}</td>
          <td>${escapeHtml(r.TituloVideo||'')}</td>
          <td>${escapeHtml(dataPart)}</td>
          <td>${assinatura}</td>
        </tr>`;
    }).join('');
  }

  function gerarXLS(){
    const base = (registrosFiltrados && registrosFiltrados.length) ? registrosFiltrados : registros;
    if(!base || !base.length) { alert('Faça uma busca primeiro.'); return; }
    const ordenada = (base===registros? [...base].sort((a,b)=> String(a.Nome||'').localeCompare(String(b.Nome||''),'pt-BR',{sensitivity:'base'})) : base);
    const linhas = ordenada.map(r => ({
      'Matrícula': r.Matricula || '',
      'Funcionário': r.Nome || '',
      'Setor': r.Setor || '',
      'Semana (ISO)': r.SemanaISO || '',
      'Título do Vídeo': r.TituloVideo || '',
      'Data de participação': formatTimestamp(r.Timestamp)
    }));
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.json_to_sheet(linhas);
    XLSX.utils.book_append_sheet(wb, ws, 'Relatório');
    XLSX.writeFile(wb, nomeArquivo('xlsx'));
  }

  async function fetchTreinamentos(){
    try{
      const res = await fetch(API_BASE + '?action=treinamentos');
      const data = await res.json();
      if (!data.ok) return [];
      return Array.isArray(data.data) ? data.data : [];
    }catch(e){ return []; }
  }

async function loadInstrutoresAsJPEG(src, maxW = 1100, maxH = 450, quality = 0.80) {
  return new Promise(resolve => {
    const img = new Image();
    img.onload = () => {
      try {
        const ratio = Math.min(maxW / img.width, maxH / img.height, 1);
        const nw = Math.round(img.width * ratio);
        const nh = Math.round(img.height * ratio);

        const c = document.createElement("canvas");
        c.width = nw;
        c.height = nh;
        c.getContext("2d").drawImage(img, 0, 0, nw, nh);

        resolve({
          dataUrl: c.toDataURL("image/jpeg", quality),
          w: nw,
          h: nh
        });
      } catch (e) {
        resolve({ dataUrl: "", w: 0, h: 0 });
      }
    };

    img.onerror = () => resolve({ dataUrl: "", w: 0, h: 0 });
    img.src = src;
  });
}

  async function gerarPDF() {

  await loadLogoAsDataURL();

  // Base dos registros
  const base = (Array.isArray(registrosFiltrados) && registrosFiltrados.length)
               ? registrosFiltrados : registros;

  if (!base || !base.length) {
    alert("Nenhum dado para gerar PDF.");
    return;
  }

  // Semana escolhida
  const inpSemana = document.getElementById("fSemanaTitulo") || document.getElementById("fSem");
  const semanaDigitada = inpSemana ? (inpSemana.value || "").trim() : "";

  // Construção da semana
  const semanasEncontradas = [...new Set(base.map(r => r.SemanaISO).filter(Boolean))];
  const titulos = [...new Set(base.map(r => r.TituloVideo).filter(Boolean))];
  const semanaPorTitulo = titulos.length ? titulos.join("; ") : "";
  const semanaISO = semanasEncontradas.join(", ") || "";
  const semanaTexto = semanaDigitada || semanaPorTitulo || semanaISO || "-";

  // Assuntos
  const treinamentos = await fetchTreinamentos();
  let assuntos = "";
  if (treinamentos && treinamentos.length) {
    const setISO = new Set(semanasEncontradas.map(String));
    let hit = treinamentos.find(t => setISO.has(String(t.SemanaISO)));
    if (!hit && semanaPorTitulo) hit = treinamentos.find(t => String(t.Titulo).trim() === titulos[0]);
    assuntos = hit && hit.Assuntos ? String(hit.Assuntos) : "";
  }

  // ============================
  // CONFIGURAÇÃO DO PDF
  // ============================
  const { jsPDF } = window.jspdf;

  const M_TOP = 28.35;      // 1 cm
  const M_BOTTOM = 28.35;   // 1 cm
  const M_LEFT = 14.17;     // 0.5 cm
  const M_RIGHT = 14.17;    // 0.5 cm

  const doc = new jsPDF({
    orientation: "portrait",
    unit: "pt",
    format: "a4",
    compress: true
  });

  const pageWidth  = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  const usableWidth = pageWidth - M_LEFT - M_RIGHT;

  // Instrutores já com a resolução final de 11cm × 5cm
  const instrutores = await loadInstrutoresAsJPEG("instrutores.png", 312, 142, 0.80);

  const LOGO_W = 120, LOGO_H = 52;
  const L_H = 14;

  // ============================
  // CABEÇALHO
  // ============================
  function drawHeader(pageNumber) {

    // Logo
    try {
      if (LOGO_DATAURL)
        doc.addImage(
          LOGO_DATAURL, "PNG",
          pageWidth - M_RIGHT - LOGO_W,
          M_TOP,
          LOGO_W,
          LOGO_H
        );
    } catch (e) {}

    // Título
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("DIÁLOGO SEMANAL DE SEGURANÇA", M_LEFT, M_TOP + 20);

    // Apenas na primeira página: Semana e Assuntos
    if (pageNumber === 1) {
      doc.setFontSize(14);
      doc.text("Semana: " + semanaTexto, M_LEFT, M_TOP + 20 + 2 * L_H);

      if (assuntos) {
        doc.setFont("helvetica", "normal");
        doc.setFontSize(12);
        const assuntoLines = doc.splitTextToSize("Assuntos: " + assuntos, usableWidth);
        doc.text(assuntoLines, M_LEFT, M_TOP + 20 + 4 * L_H);
      }
    }
  }

  // ============================
  // RODAPÉ / PAGINAÇÃO
  // ============================
  function drawFooter(pageNumber, totalPages) {

    const footerY = pageHeight - M_BOTTOM;

    const data = new Date().toLocaleString("pt-BR");

    doc.setFont("helvetica", "italic");
    doc.setFontSize(9);
    doc.text("Gerado em: " + data, M_LEFT, footerY - 3 * L_H);

    doc.setFont("helvetica", "normal");
    doc.text("Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG", M_LEFT, footerY - 2 * L_H);
    doc.text("CNPJ 33.375.601/0001-38", M_LEFT, footerY - L_H);
    doc.text(
      "Rua P, S/N, Área de Apoio do Aeroporto Internacional do Rio de Janeiro - Ilha do Governador - RJ",
      M_LEFT,
      footerY
    );

    // ========== PAGINAÇÃO ==========
    const pagText = `Página ${pageNumber} de ${totalPages}`;
    const w = doc.getTextWidth(pagText);
    doc.text(pagText, pageWidth - M_RIGHT - w, footerY - 2 * L_H);
  }

  // ============================
  // TABELA
  // ============================

  const head = [["Matrícula","Funcionário","Setor","Data de Participação","Assinatura"]];
  const body = base.map(r => [
    r.Matricula || "",
    r.Nome || "",
    r.Setor || "",
    formatTimestamp(r.Timestamp) || "",
    ""
  ]);

  // Página 1 → tabela começa abaixo do Assuntos  
  const yStartFirstPage = M_TOP + 20 + 6 * L_H;

  // Páginas seguintes → tabela começa apenas 2 linhas abaixo do título
  const yStartOtherPages = M_TOP + 20 + 2 * L_H;

  doc.autoTable({
    startY: yStartFirstPage,

    margin: { 
      left: M_LEFT, 
      right: M_RIGHT, 
      top: M_TOP,
      bottom: M_BOTTOM + 60  // reserva p/ rodapé -> não invade mais
    },

    pageBreak: 'auto',
    head, body,
    tableWidth: usableWidth,

    styles: {
      font: 'helvetica',
      fontSize: 10,
      cellPadding: 4,
      valign: 'middle'
    },

    headStyles: {
      fillColor: [33,150,243],
      textColor: 255,
      halign: 'center'
    },

    columnStyles: {
      0:{ halign:'left'  },
      1:{ halign:'left'  },
      2:{ halign:'left'  },
      3:{ halign:'left'  },
      4:{ halign:'center'}
    },

    didDrawPage: function (data) {
      const page = data.pageNumber;

      drawHeader(page);
      drawFooter(page, doc.getNumberOfPages());

      // Se não é primeira página → mover tabela para 2 linhas abaixo do título
      if (page > 1) {
        doc.autoTable.previous.finalY = yStartOtherPages;
      }
    },

    didDrawCell: function (data) {
      if (data.section === "body" && data.column.index === 4) {

        const sig = base[data.row.index].AssinaturaPNG;
        if (!sig) return;

        try {
          const cellW = data.cell.width - 6;
          const cellH = data.cell.height - 6;

          const maxW = Math.min(130, cellW);
          const maxH = Math.min(40, cellH);

          const x = data.cell.x + (data.cell.width - maxW) / 2;
          const y = data.cell.y + (data.cell.height - maxH) / 2;

          doc.addImage(sig, "PNG", x, y, maxW, maxH);
        } catch (e) {}
      }
    }
  });

  // ============================
  // IMAGEM DOS INSTRUTORES
  // ============================

  let yInstrutores = doc.lastAutoTable.finalY + 3 * L_H;

  if (instrutores && instrutores.dataUrl) {

    if (yInstrutores + 142 > pageHeight - M_BOTTOM) {
      doc.addPage();
      yInstrutores = yStartOtherPages;
    }

    doc.setFont("helvetica", "bold");
    doc.setFontSize(14);
    doc.text("INSTRUTORES RESPONSÁVEIS:", M_LEFT, yInstrutores);
    yInstrutores += 16;

    try {
      doc.addImage(instrutores.dataUrl, "JPEG", M_LEFT, yInstrutores, 312, 142);
    } catch (e) {}
  }

  // Finalização
  doc.save("Relatorio_Dialogo_Semanal_de_Seguranca.pdf");
}

  async function novoFuncionarioViaPrompt(){
    const status = document.getElementById('status');
    try{
      let mRaw = prompt('Nova matrícula (5 dígitos, apenas números):');
      if (mRaw === null) return;
      mRaw = (mRaw||'').replace(/\D/g,'');
      while (!/^\d{5}$/.test(mRaw)) {
        mRaw = prompt('Matrícula inválida. Informe 5 dígitos (ex.: 12345):', mRaw);
        if (mRaw === null) return;
        mRaw = (mRaw||'').replace(/\D/g,'');
      }
      const matricula = mRaw;
      let nome = prompt('Nome completo:');
      if (nome === null) return;
      nome = (nome||'').trim();
      if (!nome) { alert('Nome é obrigatório.'); return; }
      let setor = prompt('Setor (opcional):');
      if (setor === null) setor = '';
      setor = (setor||'').trim();
      const ok = confirm(`Confirmar cadastro?\n\nMatrícula: ${matricula}\nNome: ${nome}\nSetor: ${setor||'-'}\nAtivo: TRUE`);
      if (!ok) { status.innerHTML = '<div class="warn">Operação cancelada.</div>'; return; }
      const payload = { matricula, nome, setor, ativo: true };
      status.innerHTML = '<div class="warn">Enviando novo funcionário...</div>';
      const res = await fetch(API_BASE+'?action=addFuncionario',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      let data; try{ data = await res.json(); } catch{ data = { ok:false, error:'Resposta não-JSON', status: res.status }; }
      if(!data.ok) throw new Error(data.error || 'Falha ao incluir funcionário');
      status.innerHTML = '<div class="ok">Funcionário incluído com sucesso.</div>';
    }catch(err){
      status.innerHTML = '<div class="error">'+ (err && err.message ? err.message : 'Erro ao incluir funcionário') +'</div>';
    }
  }

  function escapeHtml(str){
    return String(str ?? '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }
  function nomeArquivo(ext){
    const hoje = new Date();
    const pad = (n)=>String(n).padStart(2,'0');
    return `DSS_GIG_Relatorio_${hoje.getFullYear()}-${pad(hoje.getMonth()+1)}-${pad(hoje.getDate())}.${ext}`;
  }
  function normalizarDataInput(v) { if (!v) return null; const [yyyy, mm, dd] = v.split('-').map(Number); return new Date(Date.UTC(yyyy, mm - 1, dd, 0, 0, 0)); }
  function fimDoDia(dIniUTC) { if (!dIniUTC) return null; return new Date(dIniUTC.getTime() + 24*60*60*1000 - 1); }
  function parseTimestamp(valor){ if (!valor) return null; let d = new Date(valor); if (!Number.isNaN(d.getTime())) return d; const rx = /^(\d{1,2})\/(\d{1,2})\/(\d{4})(?:\s+(\d{1,2}):(\d{2})(?::(\d{2}))?)?$/; const m = String(valor).trim().match(rx); if (m){ const dd=+m[1], mm=+m[2], yy=+m[3]; const hh=+(m[4]??0), mi=+(m[5]??0), ss=+(m[6]??0); return new Date(yy, mm-1, dd, hh, mi, ss);} return null; }
  function formatTimestamp(ts){ const d = parseTimestamp(ts); if (!d) return String(ts||''); const pad=(n)=>String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`; }
</script>
</body>
</html>
