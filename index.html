<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DSS GIG — Diálogo Semanal de Segurança (Colaborador)</title>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    /* Player responsivo */
    .player-container { position: relative; width: 100%; max-width: 960px; aspect-ratio: 16 / 9; display: inline-block; }
    .player-container iframe,
    .player-container #ytplayer iframe { position: absolute; inset: 0; width: 100% !important; height: 100% !important; }
  </style>
  <link rel="shortcut icon" href="icone lsg.ico">
</head>
<body>
<header class="site-header">
  <img src="logo lsg.png" alt="logo LSG" />
  <h1>DSS GIG — Diálogo Semanal de Segurança</h1>
  <p class="subtitle">Assista, assine e registre sua participação</p>
</header>

<main class="container">
  <section class="card">
    <h2>Identificação</h2>
    <div class="row">
      <label for="matricula">Matrícula</label>
      <input type="text" id="matricula" placeholder="Ex.: 12345" />
      <button id="btnBuscar" class="primary">Buscar</button>
    </div>
    <div id="funcInfo" class="info hidden"></div>
  </section>

  <section class="card hidden" id="secVideos">
    <h2>Escolha o vídeo</h2>
    <p>Mostrando apenas os vídeos que você <strong>ainda não assistiu</strong>.</p>
    <div id="listaVideos" class="video-list"></div>
  </section>

  <section class="card hidden" id="secPlayer">
    <h2 id="videoTitle">Vídeo</h2>
    <p><strong>Semana:</strong> <span id="semanaISO"></span></p>

    <div id="playerContainer" class="player-container">
      <div id="ytplayer"></div>
    </div>

    <div class="note">O botão "Registrar" aparecerá ao final do vídeo.</div>

    <div id="signatureBlock" class="signature-block hidden">
      <h3>Assinatura</h3>
      <p>Assine seu nome no quadro abaixo:</p>
      <div class="signature-wrapper"><canvas id="signaturePad" width="500" height="180"></canvas></div>
      <div class="signature-actions"><button id="btnLimpar" class="secondary">Limpar</button></div>
    </div>

    <div class="actions">
      <button id="btnRegistrar" class="primary hidden">Registrar</button>
      <button id="btnTrocarVideo" class="secondary">Trocar vídeo</button>
    </div>

    <div id="mensagem" class="message"></div>
  </section>
</main>

<footer class="site-footer"><small>© Caterair Serviços de Bordo e Hotelaria LTDA - Base GIG</small></footer>

<script>
  const API_BASE = '/api/gas';
  let funcionario=null, treinamentos=[], selectedVideo=null, player=null, signaturePad=null, videoEnded=false;

  function extractYouTubeId(url){ try{ const u=new URL(url); if(u.hostname.includes('youtu.be')) return u.pathname.slice(1); if(u.searchParams.get('v')) return u.searchParams.get('v'); const m=url.match(/embed\/([\w\-]+)/); if(m) return m[1]; }catch(e){} return null; }
  async function fetchTreinamentos(){ const res=await fetch(API_BASE+'?action=treinamentos'); try{ return await res.json(); }catch{ return {ok:false,error:'Resposta não-JSON',status:res.status} } }
  async function fetchRegistrosFuncionario(m){ const res=await fetch(API_BASE+'?action=registros&matricula='+encodeURIComponent(m)); try{ return await res.json(); }catch{ return {ok:false,error:'Resposta não-JSON',status:res.status} } }
  async function fetchFuncionario(m){ const res=await fetch(API_BASE+'?action=funcionario&matricula='+encodeURIComponent(m)); try{ return await res.json(); }catch{ return {ok:false,error:'Resposta não-JSON',status:res.status} } }

  document.getElementById('btnBuscar').addEventListener('click', async ()=>{
    const m=document.getElementById('matricula').value.trim();
    const info=document.getElementById('funcInfo'); info.classList.add('hidden'); info.innerHTML='';
    if(!m){ info.classList.remove('hidden'); info.innerHTML='<div class="warn">Informe a matrícula.</div>'; return }
    const resp=await fetchFuncionario(m);
    if(!resp||!resp.ok){ const d=resp&&resp.error?` (${resp.error}${resp.status?' - status '+resp.status:''})`:''; info.classList.remove('hidden'); info.innerHTML=`<div class="error">Falha ao consultar funcionário${d}.</div>`; return }
    if(resp.found===false){ info.classList.remove('hidden'); info.innerHTML='<div class="error">Funcionário não encontrado ou inativo.</div>'; return }

    funcionario=resp.data;
    info.classList.remove('hidden');
    info.innerHTML=`<div class="ok">Olá, <strong>${funcionario.Nome}</strong> — Setor: <strong>${funcionario.Setor||'-'}</strong>.</div>`;

    // Carrega treinamentos + registros da matrícula e filtra “não assistidos”
    const tResp=await fetchTreinamentos();
    if(!tResp||!tResp.ok){ const d=tResp&&tResp.error?` (${tResp.error}${tResp.status?' - status '+tResp.status:''})`:''; info.classList.remove('hidden'); info.innerHTML+=`<div class="error">Falha ao carregar treinamentos${d}.</div>`; return }
    const rResp=await fetchRegistrosFuncionario(m);
    if(!rResp||!rResp.ok){ const d=rResp&&rResp.error?` (${rResp.error}${rResp.status?' - status '+rResp.status:''})`:''; info.classList.remove('hidden'); info.innerHTML+=`<div class="warn">Não foi possível verificar assistidos${d}. Exibindo todos.</div>`; }

    const todos = Array.isArray(tResp.data)?tResp.data:[];
    const vistos = Array.isArray(rResp.data)?rResp.data:[];
    const vistosTitulo = new Set(vistos.map(x => String(x.TituloVideo||'').trim()).filter(Boolean));
    const vistosURL    = new Set(vistos.map(x => String(x.URLVideo||'').trim()).filter(Boolean));

    treinamentos = todos.filter(t => {
      const tTitulo = String(t.Titulo||'').trim();
      const tURL    = String(t.URL||'').trim();
      return !vistosTitulo.has(tTitulo) && !vistosURL.has(tURL);
    });

    renderListaVideos(treinamentos);
    document.getElementById('secVideos').classList.remove('hidden');
    document.getElementById('secPlayer').classList.add('hidden');
  });

  function renderListaVideos(list){
    const c=document.getElementById('listaVideos'); c.innerHTML='';
    if(!list||list.length===0){ c.innerHTML='<div class="ok">Você já assistiu todos os vídeos disponíveis. Obrigado!</div>'; return }
    list.forEach((t,idx)=>{
      const card=document.createElement('div'); card.className='video-card';
      card.innerHTML=`<div class="video-meta"><h3>${t.Titulo}</h3><p><strong>Semana:</strong> ${t.SemanaISO}</p></div><button class="primary" data-idx="${idx}">Assistir</button>`;
      card.querySelector('button').addEventListener('click',()=>selectVideo(idx));
      c.appendChild(card);
    });
  }

  function selectVideo(idx){
    selectedVideo=treinamentos[idx]; videoEnded=false;
    document.getElementById('videoTitle').textContent=selectedVideo.Titulo;
    document.getElementById('semanaISO').textContent=selectedVideo.SemanaISO;
    document.getElementById('btnRegistrar').classList.add('hidden');
    document.getElementById('signatureBlock').classList.add('hidden');
    document.getElementById('mensagem').innerHTML='';

    const vid=extractYouTubeId(selectedVideo.URL);
    if(!vid){ document.getElementById('mensagem').innerHTML='<div class="error">URL do vídeo inválida.</div>'; return }

    const init=()=>{
      if(player){ player.loadVideoById(vid); return }
      if(!window.YT||!YT.Player){ setTimeout(init,200); return }
      player=new YT.Player('ytplayer',{
        height:'100%', width:'100%',
        videoId:vid,
        playerVars:{ controls:0, disablekb:1, fs:0, rel:0, modestbranding:1, playsinline:1 },
        events:{ 'onStateChange': onPlayerStateChange }
      });
    };
    init();
  }

  function onPlayerStateChange(e){
    if(e.data===YT.PlayerState.ENDED){
      videoEnded=true;
      document.getElementById('signatureBlock').classList.remove('hidden');
      document.getElementById('btnRegistrar').classList.remove('hidden');
    }
  }

  document.getElementById('btnTrocarVideo').addEventListener('click',()=>{
    document.getElementById('secPlayer').classList.add('hidden');
    document.getElementById('btnRegistrar').classList.add('hidden');
    document.getElementById('signatureBlock').classList.add('hidden');
    selectedVideo=null;
  });

  document.getElementById('btnRegistrar').addEventListener('click', async ()=>{
    const msg=document.getElementById('mensagem'); msg.innerHTML='';
    if(!funcionario||!selectedVideo){ msg.innerHTML='<div class="error">Dados incompletos.</div>'; return }
    if(!videoEnded){ msg.innerHTML='<div class="warn">O vídeo ainda não foi concluído.</div>'; return }
    if(!signaturePad){
      const canvas=document.getElementById('signaturePad');
      signaturePad=new SignaturePad(canvas,{minWidth:1,maxWidth:2});
    }
    if(signaturePad.isEmpty()){ msg.innerHTML='<div class="warn">Por favor, assine antes de registrar.</div>'; return }

    const assinaturaPNG=signaturePad.toDataURL('image/png');
    const payload={ matricula:String(funcionario.Matricula), semanaISO:String(selectedVideo.SemanaISO), tituloVideo:String(selectedVideo.Titulo), urlVideo:String(selectedVideo.URL), assinaturaPNG, deviceInfo:navigator.userAgent };

    try{
      const res = await fetch(API_BASE+'?action=registrar',{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      let data; try{ data=await res.json() } catch{ data={ok:false,error:'Resposta não-JSON',status:res.status} }
      if(data.ok){
        msg.innerHTML='<div class="ok">Muito obrigado por assistir!</div>';
        document.getElementById('btnRegistrar').disabled=true;
        setTimeout(()=>location.reload(), 1500);
      } else {
        msg.innerHTML='<div class="error">Falha ao registrar: '+(data.error||'Erro')+'</div>';
      }
    }catch(err){ msg.innerHTML='<div class="error">Erro de conexão ao salvar o registro.</div>'; }
  });
</script>
</body>
</html>
